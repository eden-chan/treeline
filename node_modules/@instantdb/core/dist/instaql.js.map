{"version":3,"file":"instaql.js","sourceRoot":"","sources":["../src/instaql.js"],"names":[],"mappings":"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","sourcesContent":["import { query as datalogQuery } from \"./datalog\";\nimport { uuidCompare } from \"./utils/uuid\";\nimport { getAttrByFwdIdentName, getAttrByReverseIdentName } from \"./instaml\";\nimport * as s from \"./store\"; \n\n// Pattern variables\n// -----------------\n\nlet _seed = 0;\n\nfunction wildcard(friendlyName) {\n  return makeVarImpl(`_${friendlyName}`, _seed++);\n}\n\nfunction makeVarImpl(x, level) {\n  return `?${x}-${level}`;\n}\n\n// Where\n// -----------------\n\nclass AttrNotFoundError extends Error {\n  constructor(message) {\n    super(message);\n    this.name = \"AttrNotFoundError\";\n  }\n}\n\nfunction getPrimaryKeyAttr(store, ns) {\n  const primary = Object.values(store.attrs).find(\n    (a) => a[\"primary?\"] && a[\"forward-identity\"]?.[1] === ns,\n  );\n\n  if (primary) {\n    return primary;\n  }\n  return getAttrByFwdIdentName(store.attrs, ns, \"id\");\n}\n\nfunction idAttr(store, ns) {\n  const attr = getPrimaryKeyAttr(store, ns);\n\n  if (!attr) {\n    throw new AttrNotFoundError(`Could not find id attr for ${ns}`);\n  }\n  return attr;\n}\n\nfunction defaultWhere(makeVar, store, etype, level) {\n  return [eidWhere(makeVar, store, etype, level)];\n}\n\nfunction eidWhere(makeVar, store, etype, level) {\n  return [\n    makeVar(etype, level),\n    idAttr(store, etype).id,\n    makeVar(etype, level),\n    makeVar(\"time\", level),\n  ];\n}\n\nfunction replaceInAttrPat(attrPat, needle, v) {\n  return attrPat.map((x) => (x === needle ? v : x));\n}\n\nfunction refAttrPat(makeVar, store, etype, level, label) {\n  const fwdAttr = getAttrByFwdIdentName(store.attrs, etype, label);\n  const revAttr = getAttrByReverseIdentName(store.attrs, etype, label);\n  const attr = fwdAttr || revAttr;\n\n  if (!attr) {\n    throw new AttrNotFoundError(`Could not find attr for ${[etype, label]}`);\n  }\n\n  if (attr[\"value-type\"] !== \"ref\") {\n    throw new Error(`Attr ${attr.id} is not a ref`);\n  }\n\n  const [_f, fwdEtype] = attr[\"forward-identity\"];\n  const [_r, revEtype] = attr[\"reverse-identity\"];\n  const nextLevel = level + 1;\n  const attrPat = fwdAttr\n    ? [\n      makeVar(fwdEtype, level),\n      attr.id,\n      makeVar(revEtype, nextLevel),\n      wildcard(\"time\"),\n    ]\n    : [\n      makeVar(fwdEtype, nextLevel),\n      attr.id,\n      makeVar(revEtype, level),\n      wildcard(\"time\"),\n    ];\n\n  const nextEtype = fwdAttr ? revEtype : fwdEtype;\n\n  const isForward = Boolean(fwdAttr);\n\n  return [nextEtype, nextLevel, attrPat, attr, isForward];\n}\n\nfunction valueAttrPat(makeVar, store, valueEtype, valueLevel, valueLabel, v) {\n  const attr = getAttrByFwdIdentName(store.attrs, valueEtype, valueLabel);\n\n  if (!attr) {\n    throw new AttrNotFoundError(\n      `No attr for etype = ${valueEtype} label = ${valueLabel} value-label`,\n    );\n  }\n\n  return [makeVar(valueEtype, valueLevel), attr.id, v, wildcard(\"time\")];\n}\n\nfunction refAttrPats(makeVar, store, etype, level, refsPath) {\n  const [lastEtype, lastLevel, attrPats] = refsPath.reduce(\n    (acc, label) => {\n      const [etype, level, attrPats] = acc;\n      const [nextEtype, nextLevel, attrPat] = refAttrPat(\n        makeVar,\n        store,\n        etype,\n        level,\n        label,\n      );\n      return [nextEtype, nextLevel, [...attrPats, attrPat]];\n    },\n    [etype, level, []],\n  );\n\n  return [lastEtype, lastLevel, attrPats];\n}\n\nfunction whereCondAttrPats(makeVar, store, etype, level, path, v) {\n  const refsPath = path.slice(0, path.length - 1);\n  const valueLabel = path[path.length - 1];\n  const [lastEtype, lastLevel, refPats] = refAttrPats(\n    makeVar,\n    store,\n    etype,\n    level,\n    refsPath,\n  );\n  const valuePat = valueAttrPat(\n    makeVar,\n    store,\n    lastEtype,\n    lastLevel,\n    valueLabel,\n    v,\n  );\n\n  return refPats.concat([valuePat]);\n}\n\nfunction withJoin(where, join) {\n  return join ? [join].concat(where) : where;\n}\n\nfunction isOrClauses([k, v]) {\n  return k === \"or\" && Array.isArray(v);\n}\n\nfunction isAndClauses([k, v]) {\n  return k === \"and\" && Array.isArray(v);\n}\n\n// Creates a makeVar that will namespace symbols for or clauses\n// to prevent conflicts, except for the base etype\nfunction genMakeVar(baseMakeVar, etype, orIdx) {\n  return (x, lvl) => {\n    if (x == etype) {\n      return baseMakeVar(x, lvl);\n    }\n    return `${baseMakeVar(x, lvl)}-${orIdx}`;\n  };\n}\n\nfunction parseWhereClauses(\n  makeVar,\n  clauseType /* 'or' | 'and' */,\n  store,\n  etype,\n  level,\n  whereValue,\n) {\n  const patterns = whereValue.map((w, i) => {\n    const makeNamespacedVar = genMakeVar(makeVar, etype, i);\n    return parseWhere(makeNamespacedVar, store, etype, level, w);\n  });\n  const joinSym = makeVar(etype, level);\n  return { [clauseType]: { patterns, joinSym } };\n}\n\nfunction parseWhere(makeVar, store, etype, level, where) {\n  return Object.entries(where).flatMap(([k, v]) => {\n    if (isOrClauses([k, v])) {\n      return parseWhereClauses(makeVar, \"or\", store, etype, level, v);\n    }\n    if (isAndClauses([k, v])) {\n      return parseWhereClauses(makeVar, \"and\", store, etype, level, v);\n    }\n    const path = k.split(\".\");\n    return whereCondAttrPats(makeVar, store, etype, level, path, v);\n  });\n}\n\nfunction makeWhere(store, etype, level, where) {\n  const makeVar = makeVarImpl;\n  if (!where) {\n    return defaultWhere(makeVar, store, etype, level);\n  }\n  const parsedWhere = parseWhere(makeVar, store, etype, level, where);\n  return parsedWhere.concat(defaultWhere(makeVar, store, etype, level));\n}\n\n// Find\n// -----------------\n\nfunction makeFind(makeVar, etype, level) {\n  return [makeVar(etype, level), makeVar(\"time\", level)];\n}\n\n// extendObjects\n// -----------------\n\nfunction makeJoin(makeVar, store, etype, level, label, eid) {\n  const [nextEtype, nextLevel, pat, attr, isForward] = refAttrPat(\n    makeVar,\n    store,\n    etype,\n    level,\n    label,\n  );\n  const actualized = replaceInAttrPat(pat, makeVar(etype, level), eid);\n  return [nextEtype, nextLevel, actualized, attr, isForward];\n}\n\nfunction extendObjects(makeVar, store, { etype, level, form }, objects) {\n  const children = Object.keys(form).filter((c) => c !== \"$\");\n  if (!children.length) {\n    return Object.values(objects);\n  }\n  return Object.entries(objects).map(([eid, parent]) => {\n    const childResults = children.map((label) => {\n      const isSingular = Boolean(\n        store.cardinalityInference &&\n        store.linkIndex?.[etype]?.[label]?.isSingular,\n      );\n\n      try {\n        const [nextEtype, nextLevel, join] = makeJoin(\n          makeVar,\n          store,\n          etype,\n          level,\n          label,\n          eid,\n        );\n\n        const childrenArray = queryOne(store, {\n          etype: nextEtype,\n          level: nextLevel,\n          form: form[label],\n          join,\n        });\n\n        const childOrChildren = isSingular ? childrenArray[0] : childrenArray;\n\n        return { [label]: childOrChildren };\n      } catch (e) {\n        if (e instanceof AttrNotFoundError) {\n          return { [label]: isSingular ? undefined : [] };\n        }\n        throw e;\n      }\n    });\n    return childResults.reduce((parent, child) => {\n      return { ...parent, ...child };\n    }, parent);\n  });\n}\n\n// resolveObjects\n// -----------------\n\nfunction shouldIgnoreAttr(attrs, id) {\n  const attr = attrs[id];\n  return attr[\"value-type\"] === \"ref\" && attr[\"forward-identity\"][2] !== \"id\";\n}\n\nfunction cursorCompare(direction, typ) {\n  switch (direction) {\n    case \"asc\":\n      switch (typ) {\n        case \"number\":\n          return (x, y) => x < y;\n        case \"uuid\":\n          return (x, y) => uuidCompare(x, y) === -1;\n      }\n    case \"desc\":\n      switch (typ) {\n        case \"number\":\n          return (x, y) => x > y;\n        case \"uuid\":\n          return (x, y) => uuidCompare(x, y) === 1;\n      }\n  }\n}\n\nfunction isBefore(startCursor, direction, [e, _a, _v, t]) {\n  return (\n    cursorCompare(direction, \"number\")(t, startCursor[3]) ||\n    (t === startCursor[3] &&\n      cursorCompare(direction, \"uuid\")(e, startCursor[0]))\n  );\n}\n\nfunction runDataloadAndReturnObjects(store, etype, direction, pageInfo, dq) {\n  const aid = idAttr(store, etype).id;\n  const idVecs = datalogQuery(store, dq)\n    .sort(([_, tsA], [__, tsB]) => {\n      return direction === \"desc\" ? tsB - tsA : tsA - tsB;\n    });\n\n  let objects = {}\n  const startCursor = pageInfo?.[\"start-cursor\"];\n  const blobAttrs = s.blobAttrs(store, etype);\n  for (const [id, time] of idVecs) {\n    if (\n      startCursor &&\n      aid === startCursor[1] &&\n      isBefore(startCursor, direction, [id, aid, id, time])\n    ) {\n      continue;\n    }\n    const obj = s.getAsObject(store, blobAttrs, id);\n    if (obj) {\n      objects[id] = obj;\n    }\n  }\n  return objects;\n}\n\nfunction determineOrder(form) {\n  const orderOpts = form.$?.order;\n  if (!orderOpts) {\n    return \"asc\";\n  }\n\n  return orderOpts[Object.keys(orderOpts)[0]] || \"asc\";\n}\n\n/**\n * Given a query like:\n *\n * {\n *   users: {\n *     $: { where: { name: \"Joe\" } },\n *   },\n * };\n *\n * `resolveObjects`, turns where clause: `{ name: \"Joe\" }`\n * into a datalog query. We then run the datalog query,\n * and reduce all the triples into objects.\n */\nfunction resolveObjects(store, { etype, level, form, join, pageInfo }) {\n  const limit = form.$?.limit || form.$?.first || form.$?.last;\n  const offset = form.$?.offset;\n  const before = form.$?.before;\n  const after = form.$?.after;\n\n  // Wait for server to tell us where we start if we don't start from the beginning\n  if ((offset || before || after) && (!pageInfo || !pageInfo[\"start-cursor\"])) {\n    return [];\n  }\n  const where = withJoin(makeWhere(store, etype, level, form.$?.where), join);\n\n  const find = makeFind(makeVarImpl, etype, level);\n\n  const objs = runDataloadAndReturnObjects(\n    store,\n    etype,\n    determineOrder(form),\n    pageInfo,\n    { where, find },\n  );\n\n  if (limit != null) {\n    const entries = Object.entries(objs);\n    if (entries.length <= limit) {\n      return objs;\n    }\n    return Object.fromEntries(entries.slice(0, limit));\n  }\n  return objs;\n}\n\n/**\n * It's possible that we query\n * for an attribute that doesn't exist yet.\n *\n * { users: { $: { where: { nonExistentProperty: \"foo\" } } } }\n *\n * This swallows the missing attr error and returns\n * an empty result instead\n */\nfunction guardedResolveObjects(store, opts) {\n  try {\n    return resolveObjects(store, opts);\n  } catch (e) {\n    if (e instanceof AttrNotFoundError) {\n      return {};\n    }\n    throw e;\n  }\n}\n/**\n * Given a query like:\n *\n * {\n *   users: {\n *     $: { where: { name: \"Joe\" } },\n *     posts: {},\n *   },\n * };\n *\n * `guardResolveObjects` will return the relevant `users` objects\n * `extendObjects` will then extend each `user` object with relevant `posts`.\n */\nfunction queryOne(store, opts) {\n  const objects = guardedResolveObjects(store, opts);\n  return extendObjects(makeVarImpl, store, opts, objects);\n}\n\nfunction formatPageInfo(pageInfo) {\n  const res = {};\n  for (const [k, v] of Object.entries(pageInfo)) {\n    res[k] = {\n      startCursor: v[\"start-cursor\"],\n      endCursor: v[\"end-cursor\"],\n      hasNextPage: v[\"has-next-page?\"],\n      hasPreviousPage: v[\"has-previous-page?\"],\n    };\n  }\n  return res;\n}\n\nexport default function query({ store, pageInfo, aggregate }, q) {\n  const data = Object.keys(q).reduce((res, k) => {\n    if (aggregate?.[k]) {\n      // Aggregate doesn't return any join rows and has no children,\n      // so don't bother querying further\n      return res;\n    }\n    res[k] = queryOne(store, {\n      etype: k,\n      form: q[k],\n      level: 0,\n      pageInfo: pageInfo?.[k],\n    });\n    return res;\n  }, {});\n\n  const result = { data };\n  if (pageInfo) {\n    result.pageInfo = formatPageInfo(pageInfo);\n  }\n\n  if (aggregate) {\n    result.aggregate = aggregate;\n  }\n\n  return result;\n}\n"]}