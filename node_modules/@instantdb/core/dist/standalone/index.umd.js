(function(W,G){typeof exports=="object"&&typeof module<"u"?G(exports):typeof define=="function"&&define.amd?define(["exports"],G):(W=typeof globalThis<"u"?globalThis:W||self,G(W.instant={}))})(this,function(W){"use strict";var zs=Object.defineProperty;var $s=(W,G,ge)=>G in W?zs(W,G,{enumerable:!0,configurable:!0,writable:!0,value:ge}):W[G]=ge;var D=(W,G,ge)=>$s(W,typeof G!="symbol"?G+"":G,ge);const G=(()=>{let t=!1;typeof window<"u"&&typeof window.localStorage<"u"?t=!!window.localStorage.getItem("loggingEnabled"):t=!1;function e(n){return(...r)=>{t&&console[n](...r)}}return{info:e("info"),debug:e("debug"),error:e("error")}})();function ge(t){throw new Error('Could not dynamically require "'+t+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var It={exports:{}};(function(t,e){(function(n){t.exports=n()})(function(){return function n(r,s,i){function a(p,b){if(!s[p]){if(!r[p]){var E=typeof ge=="function"&&ge;if(!b&&E)return E(p,!0);if(u)return u(p,!0);throw new Error("Cannot find module '"+p+"'")}b=s[p]={exports:{}},r[p][0].call(b.exports,function(P){var L=r[p][1][P];return a(L||P)},b,b.exports,n,r,s,i)}return s[p].exports}for(var u=typeof ge=="function"&&ge,l=0;l<i.length;l++)a(i[l]);return a}({1:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){var S=n("crypto");function x(g,v){v=M(g,v);var f;return(f=v.algorithm!=="passthrough"?S.createHash(v.algorithm):new U).write===void 0&&(f.write=f.update,f.end=f.update),j(v,f).dispatch(g),f.update||f.end(""),f.digest?f.digest(v.encoding==="buffer"?void 0:v.encoding):(g=f.read(),v.encoding!=="buffer"?g.toString(v.encoding):g)}(s=r.exports=x).sha1=function(g){return x(g)},s.keys=function(g){return x(g,{excludeValues:!0,algorithm:"sha1",encoding:"hex"})},s.MD5=function(g){return x(g,{algorithm:"md5",encoding:"hex"})},s.keysMD5=function(g){return x(g,{algorithm:"md5",encoding:"hex",excludeValues:!0})};var m=S.getHashes?S.getHashes().slice():["sha1","md5"],A=(m.push("passthrough"),["buffer","hex","binary","base64"]);function M(g,v){var f={};if(f.algorithm=(v=v||{}).algorithm||"sha1",f.encoding=v.encoding||"hex",f.excludeValues=!!v.excludeValues,f.algorithm=f.algorithm.toLowerCase(),f.encoding=f.encoding.toLowerCase(),f.ignoreUnknown=v.ignoreUnknown===!0,f.respectType=v.respectType!==!1,f.respectFunctionNames=v.respectFunctionNames!==!1,f.respectFunctionProperties=v.respectFunctionProperties!==!1,f.unorderedArrays=v.unorderedArrays===!0,f.unorderedSets=v.unorderedSets!==!1,f.unorderedObjects=v.unorderedObjects!==!1,f.replacer=v.replacer||void 0,f.excludeKeys=v.excludeKeys||void 0,g===void 0)throw new Error("Object argument required.");for(var h=0;h<m.length;++h)m[h].toLowerCase()===f.algorithm.toLowerCase()&&(f.algorithm=m[h]);if(m.indexOf(f.algorithm)===-1)throw new Error('Algorithm "'+f.algorithm+'"  not supported. supported values: '+m.join(", "));if(A.indexOf(f.encoding)===-1&&f.algorithm!=="passthrough")throw new Error('Encoding "'+f.encoding+'"  not supported. supported values: '+A.join(", "));return f}function O(g){if(typeof g=="function")return/^function\s+\w*\s*\(\s*\)\s*{\s+\[native code\]\s+}$/i.exec(Function.prototype.toString.call(g))!=null}function j(g,v,f){f=f||[];function h(c){return v.update?v.update(c,"utf8"):v.write(c,"utf8")}return{dispatch:function(c){return this["_"+((c=g.replacer?g.replacer(c):c)===null?"null":typeof c)](c)},_object:function(c){var w,_=Object.prototype.toString.call(c),N=/\[object (.*)\]/i.exec(_);if(N=(N=N?N[1]:"unknown:["+_+"]").toLowerCase(),0<=(_=f.indexOf(c)))return this.dispatch("[CIRCULAR:"+_+"]");if(f.push(c),u!==void 0&&u.isBuffer&&u.isBuffer(c))return h("buffer:"),h(c);if(N==="object"||N==="function"||N==="asyncfunction")return _=Object.keys(c),g.unorderedObjects&&(_=_.sort()),g.respectType===!1||O(c)||_.splice(0,0,"prototype","__proto__","constructor"),g.excludeKeys&&(_=_.filter(function(B){return!g.excludeKeys(B)})),h("object:"+_.length+":"),w=this,_.forEach(function(B){w.dispatch(B),h(":"),g.excludeValues||w.dispatch(c[B]),h(",")});if(!this["_"+N]){if(g.ignoreUnknown)return h("["+N+"]");throw new Error('Unknown object type "'+N+'"')}this["_"+N](c)},_array:function(c,B){B=B!==void 0?B:g.unorderedArrays!==!1;var _=this;if(h("array:"+c.length+":"),!B||c.length<=1)return c.forEach(function(q){return _.dispatch(q)});var N=[],B=c.map(function(q){var T=new U,$=f.slice();return j(g,T,$).dispatch(q),N=N.concat($.slice(f.length)),T.read().toString()});return f=f.concat(N),B.sort(),this._array(B,!1)},_date:function(c){return h("date:"+c.toJSON())},_symbol:function(c){return h("symbol:"+c.toString())},_error:function(c){return h("error:"+c.toString())},_boolean:function(c){return h("bool:"+c.toString())},_string:function(c){h("string:"+c.length+":"),h(c.toString())},_function:function(c){h("fn:"),O(c)?this.dispatch("[native]"):this.dispatch(c.toString()),g.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(c.name)),g.respectFunctionProperties&&this._object(c)},_number:function(c){return h("number:"+c.toString())},_xml:function(c){return h("xml:"+c.toString())},_null:function(){return h("Null")},_undefined:function(){return h("Undefined")},_regexp:function(c){return h("regex:"+c.toString())},_uint8array:function(c){return h("uint8array:"),this.dispatch(Array.prototype.slice.call(c))},_uint8clampedarray:function(c){return h("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(c))},_int8array:function(c){return h("int8array:"),this.dispatch(Array.prototype.slice.call(c))},_uint16array:function(c){return h("uint16array:"),this.dispatch(Array.prototype.slice.call(c))},_int16array:function(c){return h("int16array:"),this.dispatch(Array.prototype.slice.call(c))},_uint32array:function(c){return h("uint32array:"),this.dispatch(Array.prototype.slice.call(c))},_int32array:function(c){return h("int32array:"),this.dispatch(Array.prototype.slice.call(c))},_float32array:function(c){return h("float32array:"),this.dispatch(Array.prototype.slice.call(c))},_float64array:function(c){return h("float64array:"),this.dispatch(Array.prototype.slice.call(c))},_arraybuffer:function(c){return h("arraybuffer:"),this.dispatch(new Uint8Array(c))},_url:function(c){return h("url:"+c.toString())},_map:function(c){return h("map:"),c=Array.from(c),this._array(c,g.unorderedSets!==!1)},_set:function(c){return h("set:"),c=Array.from(c),this._array(c,g.unorderedSets!==!1)},_file:function(c){return h("file:"),this.dispatch([c.name,c.size,c.type,c.lastModfied])},_blob:function(){if(g.ignoreUnknown)return h("[blob]");throw Error(`Hashing Blob objects is currently not supported
(see https://github.com/puleos/object-hash/issues/26)
Use "options.replacer" or "options.ignoreUnknown"
`)},_domwindow:function(){return h("domwindow")},_bigint:function(c){return h("bigint:"+c.toString())},_process:function(){return h("process")},_timer:function(){return h("timer")},_pipe:function(){return h("pipe")},_tcp:function(){return h("tcp")},_udp:function(){return h("udp")},_tty:function(){return h("tty")},_statwatcher:function(){return h("statwatcher")},_securecontext:function(){return h("securecontext")},_connection:function(){return h("connection")},_zlib:function(){return h("zlib")},_context:function(){return h("context")},_nodescript:function(){return h("nodescript")},_httpparser:function(){return h("httpparser")},_dataview:function(){return h("dataview")},_signal:function(){return h("signal")},_fsevent:function(){return h("fsevent")},_tlswrap:function(){return h("tlswrap")}}}function U(){return{buf:"",write:function(g){this.buf+=g},end:function(g){this.buf+=g},read:function(){return this.buf}}}s.writeToStream=function(g,v,f){return f===void 0&&(f=v,v={}),j(v=M(g,v),f).dispatch(g)}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/fake_9a5aa49d.js","/")},{buffer:3,crypto:5,lYpoI2:11}],2:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){(function(S){var x=typeof Uint8Array<"u"?Uint8Array:Array,m=43,A=47,M=48,O=97,j=65,U=45,g=95;function v(f){return f=f.charCodeAt(0),f===m||f===U?62:f===A||f===g?63:f<M?-1:f<M+10?f-M+26+26:f<j+26?f-j:f<O+26?f-O+26:void 0}S.toByteArray=function(f){var h,c;if(0<f.length%4)throw new Error("Invalid string. Length must be a multiple of 4");var w=f.length,w=f.charAt(w-2)==="="?2:f.charAt(w-1)==="="?1:0,_=new x(3*f.length/4-w),N=0<w?f.length-4:f.length,B=0;function q(T){_[B++]=T}for(h=0;h<N;h+=4,0)q((16711680&(c=v(f.charAt(h))<<18|v(f.charAt(h+1))<<12|v(f.charAt(h+2))<<6|v(f.charAt(h+3))))>>16),q((65280&c)>>8),q(255&c);return w==2?q(255&(c=v(f.charAt(h))<<2|v(f.charAt(h+1))>>4)):w==1&&(q((c=v(f.charAt(h))<<10|v(f.charAt(h+1))<<4|v(f.charAt(h+2))>>2)>>8&255),q(255&c)),_},S.fromByteArray=function(f){var h,c,w,_,N=f.length%3,B="";function q(T){return"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(T)}for(h=0,w=f.length-N;h<w;h+=3)c=(f[h]<<16)+(f[h+1]<<8)+f[h+2],B+=q((_=c)>>18&63)+q(_>>12&63)+q(_>>6&63)+q(63&_);switch(N){case 1:B=(B+=q((c=f[f.length-1])>>2))+q(c<<4&63)+"==";break;case 2:B=(B=(B+=q((c=(f[f.length-2]<<8)+f[f.length-1])>>10))+q(c>>4&63))+q(c<<2&63)+"="}return B}})(s===void 0?this.base64js={}:s)}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/base64-js/lib/b64.js","/node_modules/gulp-browserify/node_modules/base64-js/lib")},{buffer:3,lYpoI2:11}],3:[function(n,r,s){(function(i,a,m,l,p,b,E,P,L){var S=n("base64-js"),x=n("ieee754");function m(o,d,y){if(!(this instanceof m))return new m(o,d,y);var C,I,k,z,Y=typeof o;if(d==="base64"&&Y=="string")for(o=(z=o).trim?z.trim():z.replace(/^\s+|\s+$/g,"");o.length%4!=0;)o+="=";if(Y=="number")C=Q(o);else if(Y=="string")C=m.byteLength(o,d);else{if(Y!="object")throw new Error("First argument needs to be a number, array or string.");C=Q(o.length)}if(m._useTypedArrays?I=m._augment(new Uint8Array(C)):((I=this).length=C,I._isBuffer=!0),m._useTypedArrays&&typeof o.byteLength=="number")I._set(o);else if(J(z=o)||m.isBuffer(z)||z&&typeof z=="object"&&typeof z.length=="number")for(k=0;k<C;k++)m.isBuffer(o)?I[k]=o.readUInt8(k):I[k]=o[k];else if(Y=="string")I.write(o,0,d);else if(Y=="number"&&!m._useTypedArrays&&!y)for(k=0;k<C;k++)I[k]=0;return I}function A(o,d,y,C){return m._charsWritten=je(function(I){for(var k=[],z=0;z<I.length;z++)k.push(255&I.charCodeAt(z));return k}(d),o,y,C)}function M(o,d,y,C){return m._charsWritten=je(function(I){for(var k,z,Y=[],X=0;X<I.length;X++)z=I.charCodeAt(X),k=z>>8,z=z%256,Y.push(z),Y.push(k);return Y}(d),o,y,C)}function O(o,d,y){var C="";y=Math.min(o.length,y);for(var I=d;I<y;I++)C+=String.fromCharCode(o[I]);return C}function j(o,d,y,k){k||(R(typeof y=="boolean","missing or invalid endian"),R(d!=null,"missing offset"),R(d+1<o.length,"Trying to read beyond buffer length"));var I,k=o.length;if(!(k<=d))return y?(I=o[d],d+1<k&&(I|=o[d+1]<<8)):(I=o[d]<<8,d+1<k&&(I|=o[d+1])),I}function U(o,d,y,k){k||(R(typeof y=="boolean","missing or invalid endian"),R(d!=null,"missing offset"),R(d+3<o.length,"Trying to read beyond buffer length"));var I,k=o.length;if(!(k<=d))return y?(d+2<k&&(I=o[d+2]<<16),d+1<k&&(I|=o[d+1]<<8),I|=o[d],d+3<k&&(I+=o[d+3]<<24>>>0)):(d+1<k&&(I=o[d+1]<<16),d+2<k&&(I|=o[d+2]<<8),d+3<k&&(I|=o[d+3]),I+=o[d]<<24>>>0),I}function g(o,d,y,C){if(C||(R(typeof y=="boolean","missing or invalid endian"),R(d!=null,"missing offset"),R(d+1<o.length,"Trying to read beyond buffer length")),!(o.length<=d))return C=j(o,d,y,!0),32768&C?-1*(65535-C+1):C}function v(o,d,y,C){if(C||(R(typeof y=="boolean","missing or invalid endian"),R(d!=null,"missing offset"),R(d+3<o.length,"Trying to read beyond buffer length")),!(o.length<=d))return C=U(o,d,y,!0),2147483648&C?-1*(4294967295-C+1):C}function f(o,d,y,C){return C||(R(typeof y=="boolean","missing or invalid endian"),R(d+3<o.length,"Trying to read beyond buffer length")),x.read(o,d,y,23,4)}function h(o,d,y,C){return C||(R(typeof y=="boolean","missing or invalid endian"),R(d+7<o.length,"Trying to read beyond buffer length")),x.read(o,d,y,52,8)}function c(o,d,y,C,I){if(I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+1<o.length,"trying to write beyond buffer length"),xe(d,65535)),I=o.length,!(I<=y))for(var k=0,z=Math.min(I-y,2);k<z;k++)o[y+k]=(d&255<<8*(C?k:1-k))>>>8*(C?k:1-k)}function w(o,d,y,C,I){if(I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+3<o.length,"trying to write beyond buffer length"),xe(d,4294967295)),I=o.length,!(I<=y))for(var k=0,z=Math.min(I-y,4);k<z;k++)o[y+k]=d>>>8*(C?k:3-k)&255}function _(o,d,y,C,I){I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+1<o.length,"Trying to write beyond buffer length"),Te(d,32767,-32768)),o.length<=y||c(o,0<=d?d:65535+d+1,y,C,I)}function N(o,d,y,C,I){I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+3<o.length,"Trying to write beyond buffer length"),Te(d,2147483647,-2147483648)),o.length<=y||w(o,0<=d?d:4294967295+d+1,y,C,I)}function B(o,d,y,C,I){I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+3<o.length,"Trying to write beyond buffer length"),De(d,34028234663852886e22,-34028234663852886e22)),o.length<=y||x.write(o,d,y,C,23,4)}function q(o,d,y,C,I){I||(R(d!=null,"missing value"),R(typeof C=="boolean","missing or invalid endian"),R(y!=null,"missing offset"),R(y+7<o.length,"Trying to write beyond buffer length"),De(d,17976931348623157e292,-17976931348623157e292)),o.length<=y||x.write(o,d,y,C,52,8)}s.Buffer=m,s.SlowBuffer=m,s.INSPECT_MAX_BYTES=50,m.poolSize=8192,m._useTypedArrays=function(){try{var o=new ArrayBuffer(0),d=new Uint8Array(o);return d.foo=function(){return 42},d.foo()===42&&typeof d.subarray=="function"}catch{return!1}}(),m.isEncoding=function(o){switch(String(o).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},m.isBuffer=function(o){return!(o==null||!o._isBuffer)},m.byteLength=function(o,d){var y;switch(o+="",d||"utf8"){case"hex":y=o.length/2;break;case"utf8":case"utf-8":y=de(o).length;break;case"ascii":case"binary":case"raw":y=o.length;break;case"base64":y=Ge(o).length;break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":y=2*o.length;break;default:throw new Error("Unknown encoding")}return y},m.concat=function(o,d){if(R(J(o),`Usage: Buffer.concat(list, [totalLength])
list should be an Array.`),o.length===0)return new m(0);if(o.length===1)return o[0];if(typeof d!="number")for(I=d=0;I<o.length;I++)d+=o[I].length;for(var y=new m(d),C=0,I=0;I<o.length;I++){var k=o[I];k.copy(y,C),C+=k.length}return y},m.prototype.write=function(o,d,y,C){isFinite(d)?isFinite(y)||(C=y,y=void 0):(X=C,C=d,d=y,y=X),d=Number(d)||0;var I,k,z,Y,X=this.length-d;switch((!y||X<(y=Number(y)))&&(y=X),C=String(C||"utf8").toLowerCase()){case"hex":I=function(he,se,ie,Z){ie=Number(ie)||0;var H=he.length-ie;(!Z||H<(Z=Number(Z)))&&(Z=H),R((H=se.length)%2==0,"Invalid hex string"),H/2<Z&&(Z=H/2);for(var Ue=0;Ue<Z;Ue++){var An=parseInt(se.substr(2*Ue,2),16);R(!isNaN(An),"Invalid hex string"),he[ie+Ue]=An}return m._charsWritten=2*Ue,Ue}(this,o,d,y);break;case"utf8":case"utf-8":k=this,z=d,Y=y,I=m._charsWritten=je(de(o),k,z,Y);break;case"ascii":case"binary":I=A(this,o,d,y);break;case"base64":k=this,z=d,Y=y,I=m._charsWritten=je(Ge(o),k,z,Y);break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":I=M(this,o,d,y);break;default:throw new Error("Unknown encoding")}return I},m.prototype.toString=function(o,d,y){var C,I,k,z,Y=this;if(o=String(o||"utf8").toLowerCase(),d=Number(d)||0,(y=y!==void 0?Number(y):Y.length)===d)return"";switch(o){case"hex":C=function(X,he,se){var ie=X.length;(!he||he<0)&&(he=0),(!se||se<0||ie<se)&&(se=ie);for(var Z="",H=he;H<se;H++)Z+=V(X[H]);return Z}(Y,d,y);break;case"utf8":case"utf-8":C=function(X,he,se){var ie="",Z="";se=Math.min(X.length,se);for(var H=he;H<se;H++)X[H]<=127?(ie+=Be(Z)+String.fromCharCode(X[H]),Z=""):Z+="%"+X[H].toString(16);return ie+Be(Z)}(Y,d,y);break;case"ascii":case"binary":C=O(Y,d,y);break;case"base64":I=Y,z=y,C=(k=d)===0&&z===I.length?S.fromByteArray(I):S.fromByteArray(I.slice(k,z));break;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":C=function(X,he,se){for(var ie=X.slice(he,se),Z="",H=0;H<ie.length;H+=2)Z+=String.fromCharCode(ie[H]+256*ie[H+1]);return Z}(Y,d,y);break;default:throw new Error("Unknown encoding")}return C},m.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}},m.prototype.copy=function(o,d,y,C){if(d=d||0,(C=C||C===0?C:this.length)!==(y=y||0)&&o.length!==0&&this.length!==0){R(y<=C,"sourceEnd < sourceStart"),R(0<=d&&d<o.length,"targetStart out of bounds"),R(0<=y&&y<this.length,"sourceStart out of bounds"),R(0<=C&&C<=this.length,"sourceEnd out of bounds"),C>this.length&&(C=this.length);var I=(C=o.length-d<C-y?o.length-d+y:C)-y;if(I<100||!m._useTypedArrays)for(var k=0;k<I;k++)o[k+d]=this[k+y];else o._set(this.subarray(y,y+I),d)}},m.prototype.slice=function(o,d){var y=this.length;if(o=$(o,y,0),d=$(d,y,y),m._useTypedArrays)return m._augment(this.subarray(o,d));for(var C=d-o,I=new m(C,void 0,!0),k=0;k<C;k++)I[k]=this[k+o];return I},m.prototype.get=function(o){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(o)},m.prototype.set=function(o,d){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(o,d)},m.prototype.readUInt8=function(o,d){if(d||(R(o!=null,"missing offset"),R(o<this.length,"Trying to read beyond buffer length")),!(o>=this.length))return this[o]},m.prototype.readUInt16LE=function(o,d){return j(this,o,!0,d)},m.prototype.readUInt16BE=function(o,d){return j(this,o,!1,d)},m.prototype.readUInt32LE=function(o,d){return U(this,o,!0,d)},m.prototype.readUInt32BE=function(o,d){return U(this,o,!1,d)},m.prototype.readInt8=function(o,d){if(d||(R(o!=null,"missing offset"),R(o<this.length,"Trying to read beyond buffer length")),!(o>=this.length))return 128&this[o]?-1*(255-this[o]+1):this[o]},m.prototype.readInt16LE=function(o,d){return g(this,o,!0,d)},m.prototype.readInt16BE=function(o,d){return g(this,o,!1,d)},m.prototype.readInt32LE=function(o,d){return v(this,o,!0,d)},m.prototype.readInt32BE=function(o,d){return v(this,o,!1,d)},m.prototype.readFloatLE=function(o,d){return f(this,o,!0,d)},m.prototype.readFloatBE=function(o,d){return f(this,o,!1,d)},m.prototype.readDoubleLE=function(o,d){return h(this,o,!0,d)},m.prototype.readDoubleBE=function(o,d){return h(this,o,!1,d)},m.prototype.writeUInt8=function(o,d,y){y||(R(o!=null,"missing value"),R(d!=null,"missing offset"),R(d<this.length,"trying to write beyond buffer length"),xe(o,255)),d>=this.length||(this[d]=o)},m.prototype.writeUInt16LE=function(o,d,y){c(this,o,d,!0,y)},m.prototype.writeUInt16BE=function(o,d,y){c(this,o,d,!1,y)},m.prototype.writeUInt32LE=function(o,d,y){w(this,o,d,!0,y)},m.prototype.writeUInt32BE=function(o,d,y){w(this,o,d,!1,y)},m.prototype.writeInt8=function(o,d,y){y||(R(o!=null,"missing value"),R(d!=null,"missing offset"),R(d<this.length,"Trying to write beyond buffer length"),Te(o,127,-128)),d>=this.length||(0<=o?this.writeUInt8(o,d,y):this.writeUInt8(255+o+1,d,y))},m.prototype.writeInt16LE=function(o,d,y){_(this,o,d,!0,y)},m.prototype.writeInt16BE=function(o,d,y){_(this,o,d,!1,y)},m.prototype.writeInt32LE=function(o,d,y){N(this,o,d,!0,y)},m.prototype.writeInt32BE=function(o,d,y){N(this,o,d,!1,y)},m.prototype.writeFloatLE=function(o,d,y){B(this,o,d,!0,y)},m.prototype.writeFloatBE=function(o,d,y){B(this,o,d,!1,y)},m.prototype.writeDoubleLE=function(o,d,y){q(this,o,d,!0,y)},m.prototype.writeDoubleBE=function(o,d,y){q(this,o,d,!1,y)},m.prototype.fill=function(o,d,y){if(d=d||0,y=y||this.length,R(typeof(o=typeof(o=o||0)=="string"?o.charCodeAt(0):o)=="number"&&!isNaN(o),"value is not a number"),R(d<=y,"end < start"),y!==d&&this.length!==0){R(0<=d&&d<this.length,"start out of bounds"),R(0<=y&&y<=this.length,"end out of bounds");for(var C=d;C<y;C++)this[C]=o}},m.prototype.inspect=function(){for(var o=[],d=this.length,y=0;y<d;y++)if(o[y]=V(this[y]),y===s.INSPECT_MAX_BYTES){o[y+1]="...";break}return"<Buffer "+o.join(" ")+">"},m.prototype.toArrayBuffer=function(){if(typeof Uint8Array>"u")throw new Error("Buffer.toArrayBuffer not supported in this browser");if(m._useTypedArrays)return new m(this).buffer;for(var o=new Uint8Array(this.length),d=0,y=o.length;d<y;d+=1)o[d]=this[d];return o.buffer};var T=m.prototype;function $(o,d,y){return typeof o!="number"?y:d<=(o=~~o)?d:0<=o||0<=(o+=d)?o:0}function Q(o){return(o=~~Math.ceil(+o))<0?0:o}function J(o){return(Array.isArray||function(d){return Object.prototype.toString.call(d)==="[object Array]"})(o)}function V(o){return o<16?"0"+o.toString(16):o.toString(16)}function de(o){for(var d=[],y=0;y<o.length;y++){var C=o.charCodeAt(y);if(C<=127)d.push(o.charCodeAt(y));else for(var I=y,k=(55296<=C&&C<=57343&&y++,encodeURIComponent(o.slice(I,y+1)).substr(1).split("%")),z=0;z<k.length;z++)d.push(parseInt(k[z],16))}return d}function Ge(o){return S.toByteArray(o)}function je(o,d,y,C){for(var I=0;I<C&&!(I+y>=d.length||I>=o.length);I++)d[I+y]=o[I];return I}function Be(o){try{return decodeURIComponent(o)}catch{return"�"}}function xe(o,d){R(typeof o=="number","cannot write a non-number as a number"),R(0<=o,"specified a negative value for writing an unsigned value"),R(o<=d,"value is larger than maximum value for type"),R(Math.floor(o)===o,"value has a fractional component")}function Te(o,d,y){R(typeof o=="number","cannot write a non-number as a number"),R(o<=d,"value larger than maximum allowed value"),R(y<=o,"value smaller than minimum allowed value"),R(Math.floor(o)===o,"value has a fractional component")}function De(o,d,y){R(typeof o=="number","cannot write a non-number as a number"),R(o<=d,"value larger than maximum allowed value"),R(y<=o,"value smaller than minimum allowed value")}function R(o,d){if(!o)throw new Error(d||"Failed assertion")}m._augment=function(o){return o._isBuffer=!0,o._get=o.get,o._set=o.set,o.get=T.get,o.set=T.set,o.write=T.write,o.toString=T.toString,o.toLocaleString=T.toString,o.toJSON=T.toJSON,o.copy=T.copy,o.slice=T.slice,o.readUInt8=T.readUInt8,o.readUInt16LE=T.readUInt16LE,o.readUInt16BE=T.readUInt16BE,o.readUInt32LE=T.readUInt32LE,o.readUInt32BE=T.readUInt32BE,o.readInt8=T.readInt8,o.readInt16LE=T.readInt16LE,o.readInt16BE=T.readInt16BE,o.readInt32LE=T.readInt32LE,o.readInt32BE=T.readInt32BE,o.readFloatLE=T.readFloatLE,o.readFloatBE=T.readFloatBE,o.readDoubleLE=T.readDoubleLE,o.readDoubleBE=T.readDoubleBE,o.writeUInt8=T.writeUInt8,o.writeUInt16LE=T.writeUInt16LE,o.writeUInt16BE=T.writeUInt16BE,o.writeUInt32LE=T.writeUInt32LE,o.writeUInt32BE=T.writeUInt32BE,o.writeInt8=T.writeInt8,o.writeInt16LE=T.writeInt16LE,o.writeInt16BE=T.writeInt16BE,o.writeInt32LE=T.writeInt32LE,o.writeInt32BE=T.writeInt32BE,o.writeFloatLE=T.writeFloatLE,o.writeFloatBE=T.writeFloatBE,o.writeDoubleLE=T.writeDoubleLE,o.writeDoubleBE=T.writeDoubleBE,o.fill=T.fill,o.inspect=T.inspect,o.toArrayBuffer=T.toArrayBuffer,o}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/buffer/index.js","/node_modules/gulp-browserify/node_modules/buffer")},{"base64-js":2,buffer:3,ieee754:10,lYpoI2:11}],4:[function(n,r,s){(function(i,a,S,l,p,b,E,P,L){var S=n("buffer").Buffer,x=4,m=new S(x);m.fill(0),r.exports={hash:function(A,M,O,j){for(var U=M(function(c,w){c.length%x!=0&&(_=c.length+(x-c.length%x),c=S.concat([c,m],_));for(var _,N=[],B=w?c.readInt32BE:c.readInt32LE,q=0;q<c.length;q+=x)N.push(B.call(c,q));return N}(A=S.isBuffer(A)?A:new S(A),j),8*A.length),M=j,g=new S(O),v=M?g.writeInt32BE:g.writeInt32LE,f=0;f<U.length;f++)v.call(g,U[f],4*f,!0);return g}}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/helpers.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],5:[function(n,r,s){(function(i,a,S,l,p,b,E,P,L){var S=n("buffer").Buffer,x=n("./sha"),m=n("./sha256"),A=n("./rng"),M={sha1:x,sha256:m,md5:n("./md5")},O=64,j=new S(O);function U(c,w){var _=M[c=c||"sha1"],N=[];return _||g("algorithm:",c,"is not yet supported"),{update:function(B){return S.isBuffer(B)||(B=new S(B)),N.push(B),B.length,this},digest:function(B){var q=S.concat(N),q=w?function(T,$,Q){S.isBuffer($)||($=new S($)),S.isBuffer(Q)||(Q=new S(Q)),$.length>O?$=T($):$.length<O&&($=S.concat([$,j],O));for(var J=new S(O),V=new S(O),de=0;de<O;de++)J[de]=54^$[de],V[de]=92^$[de];return Q=T(S.concat([J,Q])),T(S.concat([V,Q]))}(_,w,q):_(q);return N=null,B?q.toString(B):q}}}function g(){var c=[].slice.call(arguments).join(" ");throw new Error([c,"we accept pull requests","http://github.com/dominictarr/crypto-browserify"].join(`
`))}j.fill(0),s.createHash=function(c){return U(c)},s.createHmac=U,s.randomBytes=function(c,w){if(!w||!w.call)return new S(A(c));try{w.call(this,void 0,new S(A(c)))}catch(_){w(_)}};var v,f=["createCredentials","createCipher","createCipheriv","createDecipher","createDecipheriv","createSign","createVerify","createDiffieHellman","pbkdf2"],h=function(c){s[c]=function(){g("sorry,",c,"is not implemented yet")}};for(v in f)h(f[v])}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/index.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./md5":6,"./rng":7,"./sha":8,"./sha256":9,buffer:3,lYpoI2:11}],6:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){var S=n("./helpers");function x(g,v){g[v>>5]|=128<<v%32,g[14+(v+64>>>9<<4)]=v;for(var f=1732584193,h=-271733879,c=-1732584194,w=271733878,_=0;_<g.length;_+=16){var N=f,B=h,q=c,T=w,f=A(f,h,c,w,g[_+0],7,-680876936),w=A(w,f,h,c,g[_+1],12,-389564586),c=A(c,w,f,h,g[_+2],17,606105819),h=A(h,c,w,f,g[_+3],22,-1044525330);f=A(f,h,c,w,g[_+4],7,-176418897),w=A(w,f,h,c,g[_+5],12,1200080426),c=A(c,w,f,h,g[_+6],17,-1473231341),h=A(h,c,w,f,g[_+7],22,-45705983),f=A(f,h,c,w,g[_+8],7,1770035416),w=A(w,f,h,c,g[_+9],12,-1958414417),c=A(c,w,f,h,g[_+10],17,-42063),h=A(h,c,w,f,g[_+11],22,-1990404162),f=A(f,h,c,w,g[_+12],7,1804603682),w=A(w,f,h,c,g[_+13],12,-40341101),c=A(c,w,f,h,g[_+14],17,-1502002290),f=M(f,h=A(h,c,w,f,g[_+15],22,1236535329),c,w,g[_+1],5,-165796510),w=M(w,f,h,c,g[_+6],9,-1069501632),c=M(c,w,f,h,g[_+11],14,643717713),h=M(h,c,w,f,g[_+0],20,-373897302),f=M(f,h,c,w,g[_+5],5,-701558691),w=M(w,f,h,c,g[_+10],9,38016083),c=M(c,w,f,h,g[_+15],14,-660478335),h=M(h,c,w,f,g[_+4],20,-405537848),f=M(f,h,c,w,g[_+9],5,568446438),w=M(w,f,h,c,g[_+14],9,-1019803690),c=M(c,w,f,h,g[_+3],14,-187363961),h=M(h,c,w,f,g[_+8],20,1163531501),f=M(f,h,c,w,g[_+13],5,-1444681467),w=M(w,f,h,c,g[_+2],9,-51403784),c=M(c,w,f,h,g[_+7],14,1735328473),f=O(f,h=M(h,c,w,f,g[_+12],20,-1926607734),c,w,g[_+5],4,-378558),w=O(w,f,h,c,g[_+8],11,-2022574463),c=O(c,w,f,h,g[_+11],16,1839030562),h=O(h,c,w,f,g[_+14],23,-35309556),f=O(f,h,c,w,g[_+1],4,-1530992060),w=O(w,f,h,c,g[_+4],11,1272893353),c=O(c,w,f,h,g[_+7],16,-155497632),h=O(h,c,w,f,g[_+10],23,-1094730640),f=O(f,h,c,w,g[_+13],4,681279174),w=O(w,f,h,c,g[_+0],11,-358537222),c=O(c,w,f,h,g[_+3],16,-722521979),h=O(h,c,w,f,g[_+6],23,76029189),f=O(f,h,c,w,g[_+9],4,-640364487),w=O(w,f,h,c,g[_+12],11,-421815835),c=O(c,w,f,h,g[_+15],16,530742520),f=j(f,h=O(h,c,w,f,g[_+2],23,-995338651),c,w,g[_+0],6,-198630844),w=j(w,f,h,c,g[_+7],10,1126891415),c=j(c,w,f,h,g[_+14],15,-1416354905),h=j(h,c,w,f,g[_+5],21,-57434055),f=j(f,h,c,w,g[_+12],6,1700485571),w=j(w,f,h,c,g[_+3],10,-1894986606),c=j(c,w,f,h,g[_+10],15,-1051523),h=j(h,c,w,f,g[_+1],21,-2054922799),f=j(f,h,c,w,g[_+8],6,1873313359),w=j(w,f,h,c,g[_+15],10,-30611744),c=j(c,w,f,h,g[_+6],15,-1560198380),h=j(h,c,w,f,g[_+13],21,1309151649),f=j(f,h,c,w,g[_+4],6,-145523070),w=j(w,f,h,c,g[_+11],10,-1120210379),c=j(c,w,f,h,g[_+2],15,718787259),h=j(h,c,w,f,g[_+9],21,-343485551),f=U(f,N),h=U(h,B),c=U(c,q),w=U(w,T)}return Array(f,h,c,w)}function m(g,v,f,h,c,w){return U((v=U(U(v,g),U(h,w)))<<c|v>>>32-c,f)}function A(g,v,f,h,c,w,_){return m(v&f|~v&h,g,v,c,w,_)}function M(g,v,f,h,c,w,_){return m(v&h|f&~h,g,v,c,w,_)}function O(g,v,f,h,c,w,_){return m(v^f^h,g,v,c,w,_)}function j(g,v,f,h,c,w,_){return m(f^(v|~h),g,v,c,w,_)}function U(g,v){var f=(65535&g)+(65535&v);return(g>>16)+(v>>16)+(f>>16)<<16|65535&f}r.exports=function(g){return S.hash(g,x,16)}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/md5.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],7:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){r.exports=function(S){for(var x,m=new Array(S),A=0;A<S;A++)!(3&A)&&(x=4294967296*Math.random()),m[A]=x>>>((3&A)<<3)&255;return m}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/rng.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{buffer:3,lYpoI2:11}],8:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){var S=n("./helpers");function x(M,O){M[O>>5]|=128<<24-O%32,M[15+(O+64>>9<<4)]=O;for(var j,U,g,v=Array(80),f=1732584193,h=-271733879,c=-1732584194,w=271733878,_=-1009589776,N=0;N<M.length;N+=16){for(var B=f,q=h,T=c,$=w,Q=_,J=0;J<80;J++){v[J]=J<16?M[N+J]:A(v[J-3]^v[J-8]^v[J-14]^v[J-16],1);var V=m(m(A(f,5),(V=h,U=c,g=w,(j=J)<20?V&U|~V&g:!(j<40)&&j<60?V&U|V&g|U&g:V^U^g)),m(m(_,v[J]),(j=J)<20?1518500249:j<40?1859775393:j<60?-1894007588:-899497514)),_=w,w=c,c=A(h,30),h=f,f=V}f=m(f,B),h=m(h,q),c=m(c,T),w=m(w,$),_=m(_,Q)}return Array(f,h,c,w,_)}function m(M,O){var j=(65535&M)+(65535&O);return(M>>16)+(O>>16)+(j>>16)<<16|65535&j}function A(M,O){return M<<O|M>>>32-O}r.exports=function(M){return S.hash(M,x,20,!0)}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],9:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){function S(O,j){var U=(65535&O)+(65535&j);return(O>>16)+(j>>16)+(U>>16)<<16|65535&U}function x(O,j){var U,g=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),v=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),f=new Array(64);O[j>>5]|=128<<24-j%32,O[15+(j+64>>9<<4)]=j;for(var h,c,w=0;w<O.length;w+=16){for(var _=v[0],N=v[1],B=v[2],q=v[3],T=v[4],$=v[5],Q=v[6],J=v[7],V=0;V<64;V++)f[V]=V<16?O[V+w]:S(S(S((c=f[V-2],A(c,17)^A(c,19)^M(c,10)),f[V-7]),(c=f[V-15],A(c,7)^A(c,18)^M(c,3))),f[V-16]),U=S(S(S(S(J,A(c=T,6)^A(c,11)^A(c,25)),T&$^~T&Q),g[V]),f[V]),h=S(A(h=_,2)^A(h,13)^A(h,22),_&N^_&B^N&B),J=Q,Q=$,$=T,T=S(q,U),q=B,B=N,N=_,_=S(U,h);v[0]=S(_,v[0]),v[1]=S(N,v[1]),v[2]=S(B,v[2]),v[3]=S(q,v[3]),v[4]=S(T,v[4]),v[5]=S($,v[5]),v[6]=S(Q,v[6]),v[7]=S(J,v[7])}return v}var m=n("./helpers"),A=function(O,j){return O>>>j|O<<32-j},M=function(O,j){return O>>>j};r.exports=function(O){return m.hash(O,x,32,!0)}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/crypto-browserify/sha256.js","/node_modules/gulp-browserify/node_modules/crypto-browserify")},{"./helpers":4,buffer:3,lYpoI2:11}],10:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){s.read=function(S,x,m,A,w){var O,j,U=8*w-A-1,g=(1<<U)-1,v=g>>1,f=-7,h=m?w-1:0,c=m?-1:1,w=S[x+h];for(h+=c,O=w&(1<<-f)-1,w>>=-f,f+=U;0<f;O=256*O+S[x+h],h+=c,f-=8);for(j=O&(1<<-f)-1,O>>=-f,f+=A;0<f;j=256*j+S[x+h],h+=c,f-=8);if(O===0)O=1-v;else{if(O===g)return j?NaN:1/0*(w?-1:1);j+=Math.pow(2,A),O-=v}return(w?-1:1)*j*Math.pow(2,O-A)},s.write=function(S,x,m,A,M,_){var j,U,g=8*_-M-1,v=(1<<g)-1,f=v>>1,h=M===23?Math.pow(2,-24)-Math.pow(2,-77):0,c=A?0:_-1,w=A?1:-1,_=x<0||x===0&&1/x<0?1:0;for(x=Math.abs(x),isNaN(x)||x===1/0?(U=isNaN(x)?1:0,j=v):(j=Math.floor(Math.log(x)/Math.LN2),x*(A=Math.pow(2,-j))<1&&(j--,A*=2),2<=(x+=1<=j+f?h/A:h*Math.pow(2,1-f))*A&&(j++,A/=2),v<=j+f?(U=0,j=v):1<=j+f?(U=(x*A-1)*Math.pow(2,M),j+=f):(U=x*Math.pow(2,f-1)*Math.pow(2,M),j=0));8<=M;S[m+c]=255&U,c+=w,U/=256,M-=8);for(j=j<<M|U,g+=M;0<g;S[m+c]=255&j,c+=w,j/=256,g-=8);S[m+c-w]|=128*_}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/ieee754/index.js","/node_modules/gulp-browserify/node_modules/ieee754")},{buffer:3,lYpoI2:11}],11:[function(n,r,s){(function(i,a,u,l,p,b,E,P,L){var S,x,m;function A(){}(i=r.exports={}).nextTick=(x=typeof window<"u"&&window.setImmediate,m=typeof window<"u"&&window.postMessage&&window.addEventListener,x?function(M){return window.setImmediate(M)}:m?(S=[],window.addEventListener("message",function(M){var O=M.source;O!==window&&O!==null||M.data!=="process-tick"||(M.stopPropagation(),0<S.length&&S.shift()())},!0),function(M){S.push(M),window.postMessage("process-tick","*")}):function(M){setTimeout(M,0)}),i.title="browser",i.browser=!0,i.env={},i.argv=[],i.on=A,i.addListener=A,i.once=A,i.off=A,i.removeListener=A,i.removeAllListeners=A,i.emit=A,i.binding=function(M){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(M){throw new Error("process.chdir is not supported")}}).call(this,n("lYpoI2"),typeof self<"u"?self:typeof window<"u"?window:{},n("buffer").Buffer,arguments[3],arguments[4],arguments[5],arguments[6],"/node_modules/gulp-browserify/node_modules/process/browser.js","/node_modules/gulp-browserify/node_modules/process")},{buffer:3,lYpoI2:11}]},{},[1])(1)})})(It);var On=It.exports;const be=On.MD5,K={Remove:"remove",Replace:"replace",Add:"add"},Mt=Symbol.for("__MUTATIVE_PROXY_DRAFT__"),In=Symbol("__MUTATIVE_RAW_RETURN_SYMBOL__"),Ne=Symbol.iterator,oe={mutable:"mutable",immutable:"immutable"},Xe={};function ae(t){var e;return(e=t.copy)!==null&&e!==void 0?e:t.original}function Se(t){return!!F(t)}function F(t){return typeof t!="object"?null:t==null?void 0:t[Mt]}function Ze(t){var e;const n=F(t);return n?(e=n.copy)!==null&&e!==void 0?e:n.original:t}function ce(t,e){if(!t||typeof t!="object")return!1;let n;return Object.getPrototypeOf(t)===Object.prototype||Array.isArray(t)||t instanceof Map||t instanceof Set||!!(e!=null&&e.mark)&&((n=e.mark(t,oe))===oe.immutable||typeof n=="function")}function Ct(t,e=[]){if(Object.hasOwnProperty.call(t,"key")){const n=F(we(t.parent.copy,t.key));if(n!==null&&(n==null?void 0:n.original)!==t.original)return null;e.push(t.parent.type===3?Array.from(t.parent.setMap.keys()).indexOf(t.key):t.key)}if(t.parent)return Ct(t.parent,e);e.reverse();try{Mn(t.copy,e)}catch{return null}return e}function Ee(t){return Array.isArray(t)?1:t instanceof Map?2:t instanceof Set?3:0}function we(t,e){return Ee(t)===2?t.get(e):t[e]}function Re(t,e,n){Ee(t)===2?t.set(e,n):t[e]=n}function et(t,e){const n=F(t);return(n?ae(n):t)[e]}function me(t,e){return t===e?t!==0||1/t===1/e:t!==t&&e!==e}function tt(t){if(t)for(;t.finalities.revoke.length>0;)t.finalities.revoke.pop()()}function Ae(t,e){return e?t:[""].concat(t).map(n=>{const r=`${n}`;return r.indexOf("/")===-1&&r.indexOf("~")===-1?r:r.replace(/~/g,"~0").replace(/\//g,"~1")}).join("/")}function Mn(t,e){for(let n=0;n<e.length-1;n+=1){const r=e[n];if(t=we(Ee(t)===3?Array.from(t):t,r),typeof t!="object")throw new Error(`Cannot resolve patch at '${e.join("/")}'.`)}return t}function Cn(t){const e=Object.create(Object.getPrototypeOf(t));return Reflect.ownKeys(t).forEach(n=>{let r=Reflect.getOwnPropertyDescriptor(t,n);if(r.enumerable&&r.configurable&&r.writable){e[n]=t[n];return}r.writable||(r.writable=!0,r.configurable=!0),(r.get||r.set)&&(r={configurable:!0,writable:!0,enumerable:r.enumerable,value:t[n]}),Reflect.defineProperty(e,n,r)}),e}const jn=Object.prototype.propertyIsEnumerable;function jt(t,e){let n;if(Array.isArray(t))return Array.prototype.concat.call(t);if(t instanceof Set)return new Set(t.values());if(t instanceof Map)return new Map(t);if(e!=null&&e.mark&&(n=e.mark(t,oe),n!==void 0)&&n!==oe.mutable){if(n===oe.immutable)return Cn(t);if(typeof n=="function"){if(e.enablePatches||e.enableAutoFreeze)throw new Error("You can't use mark and patches or auto freeze together.");return n()}throw new Error(`Unsupported mark result: ${n}`)}else if(typeof t=="object"&&Object.getPrototypeOf(t)===Object.prototype){const r={};return Object.keys(t).forEach(s=>{r[s]=t[s]}),Object.getOwnPropertySymbols(t).forEach(s=>{jn.call(t,s)&&(r[s]=t[s])}),r}else throw new Error("Please check mark() to ensure that it is a stable marker draftable function.")}function te(t){t.copy||(t.copy=jt(t.original,t.options))}function Pe(t){if(!ce(t))return Ze(t);if(Array.isArray(t))return t.map(Pe);if(t instanceof Map)return new Map(Array.from(t.entries()).map(([n,r])=>[n,Pe(r)]));if(t instanceof Set)return new Set(Array.from(t).map(Pe));const e=Object.create(Object.getPrototypeOf(t));for(const n in t)e[n]=Pe(t[n]);return e}function qe(t){return Se(t)?Pe(t):t}function pe(t){var e;t.assignedMap=(e=t.assignedMap)!==null&&e!==void 0?e:new Map,t.operated||(t.operated=!0,t.parent&&pe(t.parent))}function xt(){throw new Error("Cannot modify frozen object")}function Ie(t,e,n,r,s){{n=n??new WeakMap,r=r??[],s=s??[];const a=n.has(t)?n.get(t):t;if(r.length>0){const u=r.indexOf(a);if(a&&typeof a=="object"&&u!==-1)throw r[0]===a?new Error("Forbids circular reference"):new Error(`Forbids circular reference: ~/${s.slice(0,u).map((l,p)=>{if(typeof l=="symbol")return`[${l.toString()}]`;const b=r[p];return typeof l=="object"&&(b instanceof Map||b instanceof Set)?Array.from(b.keys()).indexOf(l):l}).join("/")}`);r.push(a),s.push(e)}else r.push(a)}if(Object.isFrozen(t)||Se(t)){r.pop(),s.pop();return}switch(Ee(t)){case 2:for(const[u,l]of t)Ie(u,u,n,r,s),Ie(l,u,n,r,s);t.set=t.clear=t.delete=xt;break;case 3:for(const u of t)Ie(u,u,n,r,s);t.add=t.clear=t.delete=xt;break;case 1:Object.freeze(t);let a=0;for(const u of t)Ie(u,a,n,r,s),a+=1;break;default:Object.freeze(t),Object.keys(t).forEach(u=>{const l=t[u];Ie(l,u,n,r,s)})}r.pop(),s.pop()}function Fe(t,e){return t instanceof Map?t.has(e):Object.prototype.hasOwnProperty.call(t,e)}function Tt(t,e){if(e in t){let n=Reflect.getPrototypeOf(t);for(;n;){const r=Reflect.getOwnPropertyDescriptor(n,e);if(r)return r;n=Reflect.getPrototypeOf(n)}}}function nt(t,e){const n=Ee(t);if(n===0)Reflect.ownKeys(t).forEach(r=>{e(r,t[r],t)});else if(n===1){let r=0;for(const s of t)e(r,s,t),r+=1}else t.forEach((r,s)=>e(s,r,t))}function Ut(t,e,n){if(Se(t)||!ce(t,n)||e.has(t)||Object.isFrozen(t))return;const r=t instanceof Set,s=r?new Map:void 0;if(e.add(t),nt(t,(i,a)=>{var u;if(Se(a)){const l=F(a);te(l);const p=!((u=l.assignedMap)===null||u===void 0)&&u.size||l.operated?l.copy:l.original;Re(r?s:t,i,p)}else Ut(a,e,n)}),s){const i=t,a=Array.from(i);i.clear(),a.forEach(u=>{i.add(s.has(u)?s.get(u):u)})}}function xn(t,e){const n=t.type===3?t.setMap:t.copy;t.finalities.revoke.length>1&&t.assignedMap.get(e)&&n&&Ut(we(n,e),t.finalities.handledSet,t.options)}function rt(t){t.type===3&&t.copy&&(t.copy.clear(),t.setMap.forEach(e=>{t.copy.add(Ze(e))}))}function st(t,e,n,r){if(t.operated&&t.assignedMap&&t.assignedMap.size>0&&!t.finalized){if(n&&r){const i=Ct(t);i&&e(t,i,n,r)}t.finalized=!0}}function it(t,e,n,r){const s=F(n);s&&(s.callbacks||(s.callbacks=[]),s.callbacks.push((i,a)=>{var u;const l=t.type===3?t.setMap:t.copy;if(me(we(l,e),n)){let p=s.original;s.copy&&(p=s.copy),rt(t),st(t,r,i,a),t.options.enableAutoFreeze&&(t.options.updatedValues=(u=t.options.updatedValues)!==null&&u!==void 0?u:new WeakMap,t.options.updatedValues.set(p,s.original)),Re(l,e,p)}}),t.options.enableAutoFreeze&&s.finalities!==t.finalities&&(t.options.enableAutoFreeze=!1)),ce(n,t.options)&&t.finalities.draft.push(()=>{const i=t.type===3?t.setMap:t.copy;me(we(i,e),n)&&xn(t,e)})}function Tn(t,e,n,r,s){let{original:i,assignedMap:a,options:u}=t,l=t.copy;l.length<i.length&&([i,l]=[l,i],[n,r]=[r,n]);for(let p=0;p<i.length;p+=1)if(a.get(p.toString())&&l[p]!==i[p]){const b=e.concat([p]),E=Ae(b,s);n.push({op:K.Replace,path:E,value:qe(l[p])}),r.push({op:K.Replace,path:E,value:qe(i[p])})}for(let p=i.length;p<l.length;p+=1){const b=e.concat([p]),E=Ae(b,s);n.push({op:K.Add,path:E,value:qe(l[p])})}if(i.length<l.length){const{arrayLengthAssignment:p=!0}=u.enablePatches;if(p){const b=e.concat(["length"]),E=Ae(b,s);r.push({op:K.Replace,path:E,value:i.length})}else for(let b=l.length;i.length<b;b-=1){const E=e.concat([b-1]),P=Ae(E,s);r.push({op:K.Remove,path:P})}}}function Un({original:t,copy:e,assignedMap:n},r,s,i,a){n.forEach((u,l)=>{const p=we(t,l),b=qe(we(e,l)),E=u?Fe(t,l)?K.Replace:K.Add:K.Remove;if(me(p,b)&&E===K.Replace)return;const P=r.concat(l),L=Ae(P,a);s.push(E===K.Remove?{op:E,path:L}:{op:E,path:L,value:b}),i.push(E===K.Add?{op:K.Remove,path:L}:E===K.Remove?{op:K.Add,path:L,value:p}:{op:K.Replace,path:L,value:p})})}function Rn({original:t,copy:e},n,r,s,i){let a=0;t.forEach(u=>{if(!e.has(u)){const l=n.concat([a]),p=Ae(l,i);r.push({op:K.Remove,path:p,value:u}),s.unshift({op:K.Add,path:p,value:u})}a+=1}),a=0,e.forEach(u=>{if(!t.has(u)){const l=n.concat([a]),p=Ae(l,i);r.push({op:K.Add,path:p,value:u}),s.unshift({op:K.Remove,path:p,value:u})}a+=1})}function ke(t,e,n,r){const{pathAsArray:s=!0}=t.options.enablePatches;switch(t.type){case 0:case 2:return Un(t,e,n,r,s);case 1:return Tn(t,e,n,r,s);case 3:return Rn(t,e,n,r,s)}}let Pn=!1;const ze=(t,e,n=!1)=>{if(typeof t=="object"&&t!==null&&(!ce(t,e)||n)&&!Pn)throw new Error("Strict mode: Mutable data cannot be accessed directly, please use 'unsafe(callback)' wrap.")},ot={get size(){return ae(F(this)).size},has(t){return ae(F(this)).has(t)},set(t,e){const n=F(this),r=ae(n);return(!r.has(t)||!me(r.get(t),e))&&(te(n),pe(n),n.assignedMap.set(t,!0),n.copy.set(t,e),it(n,t,e,ke)),this},delete(t){if(!this.has(t))return!1;const e=F(this);return te(e),pe(e),e.original.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.copy.delete(t),!0},clear(){const t=F(this);if(this.size){te(t),pe(t),t.assignedMap=new Map;for(const[e]of t.original)t.assignedMap.set(e,!1);t.copy.clear()}},forEach(t,e){const n=F(this);ae(n).forEach((r,s)=>{t.call(e,this.get(s),s,this)})},get(t){var e,n;const r=F(this),s=ae(r).get(t),i=((n=(e=r.options).mark)===null||n===void 0?void 0:n.call(e,s,oe))===oe.mutable;if(r.options.strict&&ze(s,r.options,i),i||r.finalized||!ce(s,r.options)||s!==r.original.get(t))return s;const a=Xe.createDraft({original:s,parentDraft:r,key:t,finalities:r.finalities,options:r.options});return te(r),r.copy.set(t,a),a},keys(){return ae(F(this)).keys()},values(){const t=this.keys();return{[Ne]:()=>this.values(),next:()=>{const e=t.next();return e.done?e:{done:!1,value:this.get(e.value)}}}},entries(){const t=this.keys();return{[Ne]:()=>this.entries(),next:()=>{const e=t.next();if(e.done)return e;const n=this.get(e.value);return{done:!1,value:[e.value,n]}}}},[Ne](){return this.entries()}},kn=Reflect.ownKeys(ot),Rt=(t,e,{isValuesIterator:n})=>()=>{var r,s;const i=e.next();if(i.done)return i;const a=i.value;let u=t.setMap.get(a);const l=F(u),p=((s=(r=t.options).mark)===null||s===void 0?void 0:s.call(r,u,oe))===oe.mutable;if(t.options.strict&&ze(a,t.options,p),!p&&!l&&ce(a,t.options)&&!t.finalized&&t.original.has(a)){const b=Xe.createDraft({original:a,parentDraft:t,key:a,finalities:t.finalities,options:t.options});t.setMap.set(a,b),u=b}else l&&(u=l.proxy);return{done:!1,value:n?u:[u,u]}},at={get size(){return F(this).setMap.size},has(t){const e=F(this);if(e.setMap.has(t))return!0;te(e);const n=F(t);return!!(n&&e.setMap.has(n.original))},add(t){const e=F(this);return this.has(t)||(te(e),pe(e),e.assignedMap.set(t,!0),e.setMap.set(t,t),it(e,t,t,ke)),this},delete(t){if(!this.has(t))return!1;const e=F(this);te(e),pe(e);const n=F(t);return n&&e.setMap.has(n.original)?(e.assignedMap.set(n.original,!1),e.setMap.delete(n.original)):(!n&&e.setMap.has(t)?e.assignedMap.set(t,!1):e.assignedMap.delete(t),e.setMap.delete(t))},clear(){if(!this.size)return;const t=F(this);te(t),pe(t);for(const e of t.original)t.assignedMap.set(e,!1);t.setMap.clear()},values(){const t=F(this);te(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.values(),next:Rt(t,e,{isValuesIterator:!0})}},entries(){const t=F(this);te(t);const e=t.setMap.keys();return{[Symbol.iterator]:()=>this.entries(),next:Rt(t,e,{isValuesIterator:!1})}},keys(){return this.values()},[Ne](){return this.values()},forEach(t,e){const n=this.values();let r=n.next();for(;!r.done;)t.call(e,r.value,r.value,this),r=n.next()}},Ln=Reflect.ownKeys(at),Pt=new WeakSet,kt={get(t,e,n){var r,s;const i=(r=t.copy)===null||r===void 0?void 0:r[e];if(i&&Pt.has(i))return i;if(e===Mt)return t;let a;if(t.options.mark){const p=e==="size"&&(t.original instanceof Map||t.original instanceof Set)?Reflect.get(t.original,e):Reflect.get(t.original,e,n);if(a=t.options.mark(p,oe),a===oe.mutable)return t.options.strict&&ze(p,t.options,!0),p}const u=ae(t);if(u instanceof Map&&kn.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(ot,"size").get.call(t.proxy);const p=ot[e];if(p)return p.bind(t.proxy)}if(u instanceof Set&&Ln.includes(e)){if(e==="size")return Object.getOwnPropertyDescriptor(at,"size").get.call(t.proxy);const p=at[e];if(p)return p.bind(t.proxy)}if(!Fe(u,e)){const p=Tt(u,e);return p?"value"in p?p.value:(s=p.get)===null||s===void 0?void 0:s.call(t.proxy):void 0}const l=u[e];if(t.options.strict&&ze(l,t.options),t.finalized||!ce(l,t.options))return l;if(l===et(t.original,e)){if(te(t),t.copy[e]=ut({original:t.original[e],parentDraft:t,key:t.type===1?Number(e):e,finalities:t.finalities,options:t.options}),typeof a=="function"){const p=F(t.copy[e]);return te(p),pe(p),p.copy}return t.copy[e]}return l},set(t,e,n){var r;if(t.type===3||t.type===2)throw new Error("Map/Set draft does not support any property assignment.");let s;if(t.type===1&&e!=="length"&&!(Number.isInteger(s=Number(e))&&s>=0&&(e===0||s===0||String(s)===String(e))))throw new Error("Only supports setting array indices and the 'length' property.");const i=Tt(ae(t),e);if(i!=null&&i.set)return i.set.call(t.proxy,n),!0;const a=et(ae(t),e),u=F(a);return u&&me(u.original,n)?(t.copy[e]=n,t.assignedMap=(r=t.assignedMap)!==null&&r!==void 0?r:new Map,t.assignedMap.set(e,!1),!0):(me(n,a)&&(n!==void 0||Fe(t.original,e))||(te(t),pe(t),Fe(t.original,e)&&me(n,t.original[e])?t.assignedMap.delete(e):t.assignedMap.set(e,!0),t.copy[e]=n,it(t,e,n,ke)),!0)},has(t,e){return e in ae(t)},ownKeys(t){return Reflect.ownKeys(ae(t))},getOwnPropertyDescriptor(t,e){const n=ae(t),r=Reflect.getOwnPropertyDescriptor(n,e);return r&&{writable:!0,configurable:t.type!==1||e!=="length",enumerable:r.enumerable,value:n[e]}},getPrototypeOf(t){return Reflect.getPrototypeOf(t.original)},setPrototypeOf(){throw new Error("Cannot call 'setPrototypeOf()' on drafts")},defineProperty(){throw new Error("Cannot call 'defineProperty()' on drafts")},deleteProperty(t,e){var n;return t.type===1?kt.set.call(this,t,e,void 0,t.proxy):(et(t.original,e)!==void 0||e in t.original?(te(t),pe(t),t.assignedMap.set(e,!1)):(t.assignedMap=(n=t.assignedMap)!==null&&n!==void 0?n:new Map,t.assignedMap.delete(e)),t.copy&&delete t.copy[e],!0)}};function ut(t){const{original:e,parentDraft:n,key:r,finalities:s,options:i}=t,a=Ee(e),u={type:a,finalized:!1,parent:n,original:e,copy:null,proxy:null,finalities:s,options:i,setMap:a===3?new Map(e.entries()):void 0};(r||"key"in t)&&(u.key=r);const{proxy:l,revoke:p}=Proxy.revocable(a===1?Object.assign([],u):u,kt);if(s.revoke.push(p),Pt.add(l),u.proxy=l,n){const b=n;b.finalities.draft.push((E,P)=>{var L,S;const x=F(l);let m=b.type===3?b.setMap:b.copy;const A=we(m,r),M=F(A);if(M){let O=M.original;M.operated&&(O=Ze(A)),rt(M),st(M,ke,E,P),b.options.enableAutoFreeze&&(b.options.updatedValues=(L=b.options.updatedValues)!==null&&L!==void 0?L:new WeakMap,b.options.updatedValues.set(O,M.original)),Re(m,r,O)}(S=x.callbacks)===null||S===void 0||S.forEach(O=>{O(E,P)})})}else{const b=F(l);b.finalities.draft.push((E,P)=>{rt(b),st(b,ke,E,P)})}return l}Xe.createDraft=ut;function Bn(t,e,n,r,s){var i;const a=F(t),u=(i=a==null?void 0:a.original)!==null&&i!==void 0?i:t,l=!!e.length;if(a!=null&&a.operated)for(;a.finalities.draft.length>0;)a.finalities.draft.pop()(n,r);const p=l?e[0]:a?a.operated?a.copy:a.original:t;return a&&tt(a),s&&Ie(p,p,a==null?void 0:a.options.updatedValues),[p,n&&l?[{op:K.Replace,path:[],value:e[0]}]:n,r&&l?[{op:K.Replace,path:[],value:u}]:r]}function Dn(t,e){var n;const r={draft:[],revoke:[],handledSet:new WeakSet};let s,i;e.enablePatches&&(s=[],i=[]);const u=((n=e.mark)===null||n===void 0?void 0:n.call(e,t,oe))===oe.mutable||!ce(t,e)?t:ut({original:t,parentDraft:null,finalities:r,options:e});return[u,(l=[])=>{const[p,b,E]=Bn(u,l,s,i,e.enableAutoFreeze);return e.enablePatches?[p,b,E]:p}]}function ct(t){const{rootDraft:e,value:n,useRawReturn:r=!1,isRoot:s=!0}=t;nt(n,(i,a,u)=>{const l=F(a);if(l&&e&&l.finalities===e.finalities){t.isContainDraft=!0;const p=l.original;if(u instanceof Set){const b=Array.from(u);u.clear(),b.forEach(E=>u.add(i===E?p:E))}else Re(u,i,p)}else typeof a=="object"&&a!==null&&(t.value=a,t.isRoot=!1,ct(t))}),s&&(t.isContainDraft||console.warn("The return value does not contain any draft, please use 'rawReturn()' to wrap the return value to improve performance."),r&&console.warn("The return value contains drafts, please don't use 'rawReturn()' to wrap the return value."))}function Lt(t){const e=F(t);if(!ce(t,e==null?void 0:e.options))return t;const n=Ee(t);if(e&&!e.operated)return e.original;let r;function s(){r=n===2?new Map(t):n===3?Array.from(e.setMap.values()):jt(t,e==null?void 0:e.options)}if(e){e.finalized=!0;try{s()}finally{e.finalized=!1}}else r=t;return nt(r,(i,a)=>{if(e&&me(we(e.original,i),a))return;const u=Lt(a);u!==a&&(r===t&&s(),Re(r,i,u))}),n===3?new Set(r):r}function Bt(t){if(!Se(t))throw new Error(`current() is only used for Draft, parameter: ${t}`);return Lt(t)}const Nn=(t=>function e(n,r,s){var i,a,u;if(typeof n=="function"&&typeof r!="function")return function(U,...g){return e(U,v=>n.call(this,v,...g),r)};const l=n,p=r;let b=s;if(typeof r!="function"&&(b=r),b!==void 0&&Object.prototype.toString.call(b)!=="[object Object]")throw new Error(`Invalid options: ${b}, 'options' should be an object.`);b=Object.assign(Object.assign({},t),b);const E=Se(l)?Bt(l):l,P=Array.isArray(b.mark)?(U,g)=>{for(const v of b.mark){if(typeof v!="function")throw new Error(`Invalid mark: ${v}, 'mark' should be a function.`);const f=v(U,g);if(f)return f}}:b.mark,L=(i=b.enablePatches)!==null&&i!==void 0?i:!1,S=(a=b.strict)!==null&&a!==void 0?a:!1,m={enableAutoFreeze:(u=b.enableAutoFreeze)!==null&&u!==void 0?u:!1,mark:P,strict:S,enablePatches:L};if(!ce(E,m)&&typeof E=="object"&&E!==null)throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");const[A,M]=Dn(E,m);if(typeof r!="function"){if(!ce(E,m))throw new Error("Invalid base state: create() only supports plain objects, arrays, Set, Map or using mark() to mark the state as immutable.");return[A,M]}let O;try{O=p(A)}catch(U){throw tt(F(A)),U}const j=U=>{const g=F(A);if(!Se(U)){if(U!==void 0&&!me(U,A)&&(g!=null&&g.operated))throw new Error("Either the value is returned as a new non-draft value, or only the draft is modified without returning any value.");const f=U==null?void 0:U[In];if(f){const h=f[0];return m.strict&&typeof U=="object"&&U!==null&&ct({rootDraft:g,value:U,useRawReturn:!0}),M([h])}if(U!==void 0)return typeof U=="object"&&U!==null&&ct({rootDraft:g,value:U}),M([U])}if(U===A||U===void 0)return M([]);const v=F(U);if(m===v.options){if(v.operated)throw new Error("Cannot return a modified child draft.");return M([Bt(U)])}return M([U])};return O instanceof Promise?O.then(j,U=>{throw tt(F(A)),U}):j(O)})();Object.prototype.constructor.toString();function Dt(t,e){const n=Object.keys(t),r=Object.keys(e);return n.length===r.length&&Object.keys(t).every(s=>e.hasOwnProperty(s))}function Nt(t,e){return Object.keys(t).length===Object.keys(e).length&&Object.keys(t).every(n=>e.hasOwnProperty(n)&&t[n]===e[n])}function $e(t,e){return typeof t!="object"||typeof e!="object"||t===null||e===null?t===e:Dt(t,e)?Object.keys(t).every(n=>$e(t[n],e[n])):!1}function qt(t,e){if(!Me(t)||!Me(e))return e;const n={};for(const r of Object.keys(t))e[r]!==null&&(n[r]=t[r]);for(const r of Object.keys(e)){if(e[r]===null)continue;const s=Me(t[r])&&Me(e[r]);n[r]=s?qt(t[r],e[r]):e[r]}return n}function Ft(t,e,n){if(!Me(t))return t;const r={};for(const[s,i]of Object.entries(t))r[s]=Me(i)?Ft(i,e,n):i===e?n:i;return r}function Me(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function qn(t){return t.cardinality==="one"}function ft(t){return t["value-type"]==="ref"}function zt(t){return t["value-type"]==="blob"}function Ve(t,e){return t[e]}function lt(t,e){return e.reduce((n,r)=>n&&n.get(r),t)}function fe(t,e){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.delete(e[0]);return}const[n,...r]=e;t.has(n)&&fe(t.get(n),r)}function ye(t,e,n){if(e.length===0)throw new Error("path must have at least one element");if(e.length===1){t.set(e[0],n);return}const[r,...s]=e;let i=t.get(r);i||(i=new Map,t.set(r,i)),ye(i,s,n)}function $t(t,e){const n=new Map,r=new Map,s=new Map;for(const i of e){const[a,u,l,p]=i,b=Ve(t,u);if(!b){console.warn("no such attr",a,t);continue}ft(b)&&ye(s,[l,u,a],i),ye(n,[a,u,l],i),ye(r,[u,a,l],i)}return{eav:n,aev:r,vae:s}}function Fn({attrs:t},e){return Object.values(t).filter(n=>zt(n)&&n["forward-identity"][1]===e)}function zn(t,e,n){var s;const r={};for(const i of e){const a=(s=t.eav.get(n))==null?void 0:s.get(i.id),u=le(a,1);for(const l of u)r[i["forward-identity"][2]]=l[2]}return r}function $n(t){return{__type:t.__type,attrs:t.attrs,triples:le(t.eav,3),cardinalityInference:t.cardinalityInference,linkIndex:t.linkIndex}}function Vn(t){return dt(t.attrs,t.triples,t.cardinalityInference,t.linkIndex)}function dt(t,e,n,r){const s=$t(t,e);return s.attrs=t,s.cardinalityInference=n,s.linkIndex=r,s.__type="store",s}function We(t,e){var s,i;let n;if(Array.isArray(e[0])){const[a,u]=e[0],l=t.aev.get(a);if(!l)return null;n=(s=le(l,2).find(b=>b[2]===u))==null?void 0:s[0]}else n=e[0];if(!n)return null;const r=e[2];if(Array.isArray(r)&&r.length===2&&t.aev.get(r[0])){const[a,u]=r,l=t.aev.get(a);if(!l)return null;const b=(i=le(l,2).find(x=>x[2]===u))==null?void 0:i[0];if(!b)return null;const[E,P,L,...S]=e;return[n,P,b,...S]}else{const[a,...u]=e;return[n,...u]}}function Wn(t,e){const n=We(t,e);if(!n)return;const[r,s,i]=n,a=Ve(t.attrs,s);a&&(fe(t.eav,[r,s,i]),fe(t.aev,[s,r,i]),ft(a)&&fe(t.vae,[i,s,r]))}let Qn=0;function Vt(t,e,n){const[r,s,i]=n;let a;const u=lt(t.ea,[r,s,i]);return u&&(a=u[3]),a||Date.now()*10+Qn++}function Jn(t,e){const n=We(t,e);if(!n)return;const[r,s,i]=n,a=Ve(t.attrs,s);if(!a)return;const u=lt(t.eav,[r,s,i]),l=(u==null?void 0:u[3])??Vt(t,a,n),p=[r,s,i,l];qn(a)?(ye(t.eav,[r,s],new Map([[i,p]])),ye(t.aev,[s,r],new Map([[i,p]]))):(ye(t.eav,[r,s,i],p),ye(t.aev,[s,r,i],p)),ft(a)&&ye(t.vae,[i,s,r],p)}function Yn(t,e){var P;const n=We(t,e);if(!n)return;const[r,s,i]=n,a=Ve(t.attrs,s);if(!a)return;if(!zt(a))throw new Error("merge operation is not supported for links");const u=lt(t.eav,[r,s]);if(!u)return;const l=(P=u.values().next())==null?void 0:P.value;if(!l)return;const p=l[2],b=qt(p,i),E=[r,s,b,Vt(t,a,l)];ye(t.eav,[r,s],new Map([[b,E]]))}function Kn(t,e){var l,p;const[n,r]=e,s=We(t,[n]);if(!s)return;const[i]=s,a=t.eav.get(i);if(a){for(const b of a.keys()){const E=t.attrs[b];(!r||!E||((l=E["forward-identity"])==null?void 0:l[1])===r)&&(fe(t.aev,[b,i]),fe(t.eav,[i,b]))}a.size===0&&fe(t.eav,[i])}const u=t.vae.get(i)&&le(t.vae.get(i),2);u&&u.forEach(b=>{var x;const[E,P,L]=b,S=t.attrs[P];(!r||!S||((x=S["reverse-identity"])==null?void 0:x[1])===r)&&(fe(t.eav,[E,P,L]),fe(t.aev,[P,E,L]),fe(t.vae,[L,P,E]))}),((p=t.vae.get(i))==null?void 0:p.size)===0&&fe(t.vae,[i])}function Wt(t,e){const n=$t(t.attrs,e);Object.keys(n).forEach(r=>{t[r]=n[r]})}function Hn(t,[e]){t.attrs[e.id]=e}function Qt(t){return le(t.eav,3)}function Gn(t,[e]){if(!t.attrs[e])return;const n=Qt(t).filter(([r,s])=>s!==e);delete t.attrs[e],Wt(t,n)}function Xn(t,[e]){const n=t.attrs[e.id];n&&(t.attrs[e.id]={...n,...e},Wt(t,Qt(t)))}function Zn(t,e){const[n,...r]=e;switch(n){case"add-triple":Jn(t,r);break;case"deep-merge-triple":Yn(t,r);break;case"retract-triple":Wn(t,r);break;case"delete-entity":Kn(t,r);break;case"add-attr":Hn(t,r);break;case"delete-attr":Gn(t,r);break;case"update-attr":Xn(t,r);break;default:throw new Error(`unhandled transaction action: ${n}`)}}function le(t,e,n=[]){if(!t||e===0)return n;if(e===1){for(const r of t.values())n.push(r);return n}for(const r of t.values())le(r,e-1,n);return n}function Qe(t,e){const n=[],r=e.in?e.in:[e];for(const s of r){const i=t.get(s);i&&n.push(i)}return n}function er(t,e,n){let r="";return t!==void 0&&(r+="e"),e!==void 0&&(r+="a"),n!==void 0&&(r+="v"),r}function tr(t,[e,n,r]){var i,a;switch(er(e,n,r)){case"e":{const u=t.eav.get(e);return le(u,2)}case"ea":{const u=(i=t.eav.get(e))==null?void 0:i.get(n);return le(u,1)}case"eav":{const u=(a=t.eav.get(e))==null?void 0:a.get(n);return u?Qe(u,r):[]}case"ev":{const u=t.eav.get(e);if(!u)return[];const l=[];for(const p of u.values())l.push(...Qe(p,r));return l}case"a":{const u=t.aev.get(n);return le(u,2)}case"av":{const u=t.aev.get(n);if(!u)return[];const l=[];for(const p of u.values())l.push(...Qe(p,r));return l}case"v":{const u=[];for(const l of t.eav.values())for(const p of l.values())u.push(...Qe(p,r))}default:return le(t.eav,3)}}function nr(t,e){return Nn(t,n=>{e.forEach(r=>{Zn(n,r)})})}function rr(t){return typeof t=="string"&&t.startsWith("?")}function sr(t,e,n){if(n.hasOwnProperty(t)){const r=n[t];return Yt(r,e,n)}return{...n,[t]:e}}function Jt(t,e,n){return t===e?n:null}function ir(t,e,n){const{in:r}=t;return r&&r.includes(e)?n:null}function or(t){switch(typeof t){case"string":return t.startsWith("?")?sr:Jt;case"object":return ir;default:return Jt}}function Yt(t,e,n){return n?or(t)(t,e,n):null}function ar(t,e,n){return t.reduce((r,s,i)=>{const a=e[i];return Yt(s,a,r)},n)}function ur(t,e,n){return lr(t,e,n).map(r=>ar(e,r,n)).filter(r=>r)}function cr(t,e,n){return e.or?e.or.patterns.flatMap(r=>ht(t,r,n)):e.and?e.and.patterns.reduce((r,s)=>ht(t,s,r),n):n.flatMap(r=>ur(t,e,r))}function ht(t,e,n=[{}]){return e.reduce((r,s)=>cr(t,s,r),n)}function pt(t,e){return Array.isArray(e)?e.map(n=>pt(t,n)):rr(e)?t[e]:e}function fr(t,{find:e,where:n}){return ht(t,n).map(s=>pt(s,e))}function lr(t,e,n){return tr(t,pt(n,e))}let Je;const dr=new Uint8Array(16);function hr(){if(!Je&&(Je=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Je))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Je(dr)}const ee=[];for(let t=0;t<256;++t)ee.push((t+256).toString(16).slice(1));function pr(t,e=0){return ee[t[e+0]]+ee[t[e+1]]+ee[t[e+2]]+ee[t[e+3]]+"-"+ee[t[e+4]]+ee[t[e+5]]+"-"+ee[t[e+6]]+ee[t[e+7]]+"-"+ee[t[e+8]]+ee[t[e+9]]+"-"+ee[t[e+10]]+ee[t[e+11]]+ee[t[e+12]]+ee[t[e+13]]+ee[t[e+14]]+ee[t[e+15]]}const Kt={randomUUID:typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function yr(t,e,n){if(Kt.randomUUID&&!e&&!t)return Kt.randomUUID();t=t||{};const r=t.random||(t.rng||hr)();return r[6]=r[6]&15|64,r[8]=r[8]&63|128,pr(r)}function Ht(t){const e=t.replace(/-/g,""),n=[];for(let r=0;r<e.length;r+=2)n.push(parseInt(e.substring(r,r+2),16));return n}function gr(t,e){for(let n=0;n<t.length;n++){if(t[n]<e[n])return-1;if(t[n]>e[n])return 1}return 0}function Gt(t,e){return gr(Ht(t),Ht(e))}function ne(){return yr()}function yt(t,e,n){return new Proxy({},{get:(r,s)=>s==="__ops"?n:i=>yt(t,e,[...n,[s,t,e,i]])})}function br(t,e){return`lookup__${t}__${JSON.stringify(e)}`}function gt(t){return t.startsWith("lookup__")}function Xt(t){const[e,n,...r]=t.split("__");return[n,JSON.parse(r.join("__"))]}function wr(t){return new Proxy({},{get(e,n){return gt(n)?yt(t,Xt(n),[]):yt(t,n,[])}})}function bt(){return new Proxy({},{get(t,e){return wr(e)}})}const mr=bt();function Zt(t){return t.__ops}function _r(t,e){const{attrIdMap:n,refSwapAttrIds:r}=t,s=[];for(const a of e){const u=n[a];if(u)s.push(u);else if(Array.isArray(a)&&a.length==2&&n[a[0]]){const[l,p]=a;s.push([n[l],p])}else s.push(a)}const[i]=e;if((i==="add-triple"||i==="retract-triple")&&r.has(e[2])){const a=s[1];s[1]=s[3],s[3]=a}return s}function re(t,e,n){return Object.values(t).find(r=>{const[s,i,a]=r["forward-identity"];return i===e&&a===n})}function Ce(t,e,n){return Object.values(t).find(r=>{const s=r["reverse-identity"];if(!s)return!1;const[i,a,u]=s;return a===e&&u===n})}function vr(t){if(Array.isArray(t))return t;const e=Object.entries(t);if(e.length!==1)throw new Error("lookup must be an object with a single unique attr and value.");return e[0]}function en(t,e,n){return n.indexOf(".")!==-1&&!re(t,e,n)}function tn(t){const[e,n,...r]=t.split(".");if(r.length>0||n!=="id")throw new Error(`${t} is not a valid lookup attribute.`);return e}function Sr(t,e,n){if(!en(t,e,n))return re(t,e,n);const r=tn(n),s=re(t,e,r);if(s&&s["value-type"]!=="ref")throw new Error(`${n} does not reference a valid link attribute.`);return s}function nn(t){return typeof t=="string"&&!gt(t)?null:typeof t=="string"&&gt(t)?Xt(t):vr(t)}function ue(t,e,n){const r=nn(n);if(r===null)return n;const[s,i]=r,a=Sr(t,e,s);if(!a||!a["unique?"])throw new Error(`${s} is not a unique attribute.`);return[a.id,i]}function Er(t,[e,n,r]){return Object.entries(r).flatMap(([i,a])=>{const u=Array.isArray(a)?a:[a],l=re(t,e,i),p=Ce(t,e,i);return u.map(b=>l?["add-triple",ue(t,e,n),l.id,ue(t,l["reverse-identity"][1],b)]:["add-triple",ue(t,p["forward-identity"][1],b),p.id,ue(t,e,n)])})}function Ar(t,[e,n,r]){return Object.entries(r).flatMap(([i,a])=>{const u=Array.isArray(a)?a:[a],l=re(t,e,i),p=Ce(t,e,i);return u.map(b=>l?["retract-triple",ue(t,e,n),l.id,ue(t,l["reverse-identity"][1],b)]:["retract-triple",ue(t,p["forward-identity"][1],b),p.id,ue(t,e,n)])})}function Or(t,[e,n,r]){const s=ue(t,e,n);return[["id",ue(t,e,n)]].concat(Object.entries(r)).map(([a,u])=>{const l=re(t,e,a);return["add-triple",s,l.id,u]})}function Ir(t,[e,n]){return[["delete-entity",ue(t,e,n),e]]}function Mr(t,[e,n,r]){const s=ue(t,e,n),i=Object.entries(r).map(([u,l])=>{const p=re(t,e,u),b=Ft(l,void 0,null);return["deep-merge-triple",s,p.id,b]});return[["add-triple",s,re(t,e,"id").id,s]].concat(i)}function Cr(t,[e,...n]){switch(e){case"merge":return Mr(t,n);case"update":return Or(t,n);case"link":return Er(t,n);case"unlink":return Ar(t,n);case"delete":return Ir(t,n);default:throw new Error(`unsupported action ${e}`)}}function rn(t,e,n){const r=ne(),i=[ne(),t,e];return{id:r,"forward-identity":i,"value-type":"blob",cardinality:"one","unique?":!1,"index?":!1,isUnsynced:!0,...n||{}}}function sn(t,e,n){const r=ne(),s=ne(),i=ne();return{id:r,"forward-identity":[s,t,e],"reverse-identity":[i,e,t],"value-type":"ref",cardinality:"many","unique?":!1,"index?":!1,isUnsynced:!0,...n||{}}}const jr=new Set(["update","merge","link","unlink"]),xr=new Set(["link","unlink"]),Tr=new Set(["update","merge"]),Ur=new Set(["link","unlink","update","merge","delete"]),on={"unique?":!0,"index?":!0},Rr={...on,cardinality:"one"};function Pr(t,e){const[n,r,s]=[new Set,{...t},[]];function i(u){r[u.id]=u,s.push(["add-attr",u]),n.add(u.id)}function a(u){u!=null&&u.isUnsynced&&!n.has(u.id)&&(s.push(["add-attr",u]),n.add(u.id))}for(const u of e){const[l,p,b,E]=u;if(Ur.has(l)){const P=nn(b);if(P){const L=P[0];if(en(r,p,L)){const S=tn(L),x=re(r,p,S),m=Ce(r,p,S);!x&&!m&&i(sn(p,S,Rr)),a(x),a(m)}else{const S=re(r,p,L);S||i(rn(p,L,on)),a(S)}}}}for(const u of e){const[l,p,b,E]=u;if(jr.has(l)){const P=Object.keys(E);P.push("id");for(const L of P){const S=re(r,p,L);if(a(S),Tr.has(l)&&(S||i(rn(p,L))),xr.has(l)){const x=Ce(r,p,L);!S&&!x&&i(sn(p,L)),a(x)}}}}return[r,s]}function kr(t,e){const r=(Array.isArray(e)?e:[e]).flatMap(u=>Zt(u)),[s,i]=Pr(t,r),a=r.flatMap(u=>Cr(s,u));return[...i,...a]}let Lr=0;function wt(t){return Ye(`_${t}`,Lr++)}function Ye(t,e){return`?${t}-${e}`}class Le extends Error{constructor(e){super(e),this.name="AttrNotFoundError"}}function Br(t,e){const n=Object.values(t.attrs).find(r=>{var s;return r["primary?"]&&((s=r["forward-identity"])==null?void 0:s[1])===e});return n||re(t.attrs,e,"id")}function an(t,e){const n=Br(t,e);if(!n)throw new Le(`Could not find id attr for ${e}`);return n}function un(t,e,n,r){return[Dr(t,e,n,r)]}function Dr(t,e,n,r){return[t(n,r),an(e,n).id,t(n,r),t("time",r)]}function Nr(t,e,n){return t.map(r=>r===e?n:r)}function cn(t,e,n,r,s){const i=re(e.attrs,n,s),a=Ce(e.attrs,n,s),u=i||a;if(!u)throw new Le(`Could not find attr for ${[n,s]}`);if(u["value-type"]!=="ref")throw new Error(`Attr ${u.id} is not a ref`);const[l,p]=u["forward-identity"],[b,E]=u["reverse-identity"],P=r+1,L=i?[t(p,r),u.id,t(E,P),wt("time")]:[t(p,P),u.id,t(E,r),wt("time")];return[i?E:p,P,L,u,!!i]}function qr(t,e,n,r,s,i){const a=re(e.attrs,n,s);if(!a)throw new Le(`No attr for etype = ${n} label = ${s} value-label`);return[t(n,r),a.id,i,wt("time")]}function Fr(t,e,n,r,s){const[i,a,u]=s.reduce((l,p)=>{const[b,E,P]=l,[L,S,x]=cn(t,e,b,E,p);return[L,S,[...P,x]]},[n,r,[]]);return[i,a,u]}function zr(t,e,n,r,s,i){const a=s.slice(0,s.length-1),u=s[s.length-1],[l,p,b]=Fr(t,e,n,r,a),E=qr(t,e,l,p,u,i);return b.concat([E])}function $r(t,e){return e?[e].concat(t):t}function Vr([t,e]){return t==="or"&&Array.isArray(e)}function Wr([t,e]){return t==="and"&&Array.isArray(e)}function Qr(t,e,n){return(r,s)=>r==e?t(r,s):`${t(r,s)}-${n}`}function fn(t,e,n,r,s,i){const a=i.map((l,p)=>{const b=Qr(t,r,p);return ln(b,n,r,s,l)}),u=t(r,s);return{[e]:{patterns:a,joinSym:u}}}function ln(t,e,n,r,s){return Object.entries(s).flatMap(([i,a])=>{if(Vr([i,a]))return fn(t,"or",e,n,r,a);if(Wr([i,a]))return fn(t,"and",e,n,r,a);const u=i.split(".");return zr(t,e,n,r,u,a)})}function Jr(t,e,n,r){const s=Ye;return r?ln(s,t,e,n,r).concat(un(s,t,e,n)):un(s,t,e,n)}function Yr(t,e,n){return[t(e,n),t("time",n)]}function Kr(t,e,n,r,s,i){const[a,u,l,p,b]=cn(t,e,n,r,s),E=Nr(l,t(n,r),i);return[a,u,E,p,b]}function Hr(t,e,{etype:n,level:r,form:s},i){const a=Object.keys(s).filter(u=>u!=="$");return a.length?Object.entries(i).map(([u,l])=>a.map(b=>{var P,L,S;const E=!!(e.cardinalityInference&&((S=(L=(P=e.linkIndex)==null?void 0:P[n])==null?void 0:L[b])!=null&&S.isSingular));try{const[x,m,A]=Kr(t,e,n,r,b,u),M=hn(e,{etype:x,level:m,form:s[b],join:A}),O=E?M[0]:M;return{[b]:O}}catch(x){if(x instanceof Le)return{[b]:E?void 0:[]};throw x}}).reduce((b,E)=>({...b,...E}),l)):Object.values(i)}function dn(t,e){switch(t){case"asc":switch(e){case"number":return(n,r)=>n<r;case"uuid":return(n,r)=>Gt(n,r)===-1}case"desc":switch(e){case"number":return(n,r)=>n>r;case"uuid":return(n,r)=>Gt(n,r)===1}}}function Gr(t,e,[n,r,s,i]){return dn(e,"number")(i,t[3])||i===t[3]&&dn(e,"uuid")(n,t[0])}function Xr(t,e,n,r,s){const i=an(t,e).id,a=fr(t,s).sort(([b,E],[P,L])=>n==="desc"?L-E:E-L);let u={};const l=r==null?void 0:r["start-cursor"],p=Fn(t,e);for(const[b,E]of a){if(l&&i===l[1]&&Gr(l,n,[b,i,b,E]))continue;const P=zn(t,p,b);P&&(u[b]=P)}return u}function Zr(t){var n;const e=(n=t.$)==null?void 0:n.order;return e&&e[Object.keys(e)[0]]||"asc"}function es(t,{etype:e,level:n,form:r,join:s,pageInfo:i}){var L,S,x,m,A,M,O;const a=((L=r.$)==null?void 0:L.limit)||((S=r.$)==null?void 0:S.first)||((x=r.$)==null?void 0:x.last),u=(m=r.$)==null?void 0:m.offset,l=(A=r.$)==null?void 0:A.before,p=(M=r.$)==null?void 0:M.after;if((u||l||p)&&(!i||!i["start-cursor"]))return[];const b=$r(Jr(t,e,n,(O=r.$)==null?void 0:O.where),s),E=Yr(Ye,e,n),P=Xr(t,e,Zr(r),i,{where:b,find:E});if(a!=null){const j=Object.entries(P);return j.length<=a?P:Object.fromEntries(j.slice(0,a))}return P}function ts(t,e){try{return es(t,e)}catch(n){if(n instanceof Le)return{};throw n}}function hn(t,e){const n=ts(t,e);return Hr(Ye,t,e,n)}function ns(t){const e={};for(const[n,r]of Object.entries(t))e[n]={startCursor:r["start-cursor"],endCursor:r["end-cursor"],hasNextPage:r["has-next-page?"],hasPreviousPage:r["has-previous-page?"]};return e}function rs({store:t,pageInfo:e,aggregate:n},r){const i={data:Object.keys(r).reduce((a,u)=>(n!=null&&n[u]||(a[u]=hn(t,{etype:u,form:r[u],level:0,pageInfo:e==null?void 0:e[u]})),a),{})};return e&&(i.pageInfo=ns(e)),n&&(i.aggregate=n),i}class mt{constructor(e){this.dbName=e,this._storeName="kv",this._dbPromise=this._init()}_init(){return new Promise((e,n)=>{const r=indexedDB.open(this.dbName,1);r.onerror=s=>{n(s)},r.onsuccess=s=>{e(s.target.result)},r.onupgradeneeded=s=>{s.target.result.createObjectStore(this._storeName)}})}async getItem(e){const n=await this._dbPromise;return new Promise((r,s)=>{const u=n.transaction([this._storeName],"readonly").objectStore(this._storeName).get(e);u.onerror=l=>{s(l)},u.onsuccess=l=>{u.result?r(u.result):r(null)}})}async setItem(e,n){const r=await this._dbPromise;return new Promise((s,i)=>{const l=r.transaction([this._storeName],"readwrite").objectStore(this._storeName).put(n,e);l.onerror=p=>{i(p)},l.onsuccess=p=>{s()}})}}class _t{static async getIsOnline(){return navigator.onLine}static listen(e){const n=()=>{e(!0)},r=()=>{e(!1)};return addEventListener("online",n),addEventListener("offline",r),()=>{removeEventListener("online",n),removeEventListener("offline",r)}}}async function _e(t,e){const n=await fetch(t,e),r=await n.json();return n.status===200?Promise.resolve(r):Promise.reject({status:n.status,body:r})}function ss({apiURI:t,appId:e,email:n}){return _e(`${t}/runtime/auth/send_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n})})}async function is({apiURI:t,appId:e,email:n,code:r}){return await _e(`${t}/runtime/auth/verify_magic_code`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,email:n,code:r})})}async function os({apiURI:t,appId:e,refreshToken:n}){return await _e(`${t}/runtime/auth/verify_refresh_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({"app-id":e,"refresh-token":n})})}async function pn({apiURI:t,appId:e,code:n,codeVerifier:r}){return await _e(`${t}/runtime/oauth/token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,code:n,code_verifier:r})})}async function as({apiURI:t,appId:e,nonce:n,idToken:r,clientName:s,refreshToken:i}){return await _e(`${t}/runtime/oauth/id_token`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,nonce:n,id_token:r,client_name:s,refresh_token:i})})}async function us({apiURI:t,appId:e,refreshToken:n}){return await _e(`${t}/runtime/signout`,{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({app_id:e,refresh_token:n})})}async function cs({apiURI:t,appId:e,fileName:n,refreshToken:r,metadata:s={}}){const{data:i}=await _e(`${t}/storage/signed-upload-url`,{method:"POST",headers:{"content-type":"application/json",authorization:`Bearer ${r}`},body:JSON.stringify({app_id:e,filename:n})});return i}async function fs(t,e){return(await fetch(t,{method:"PUT",body:e,headers:{"Content-Type":e.type}})).ok}async function ls({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await _e(`${t}/storage/signed-download-url?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"GET",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}async function ds({apiURI:t,appId:e,path:n,refreshToken:r}){const{data:s}=await _e(`${t}/storage/files?app_id=${e}&filename=${encodeURIComponent(n)}`,{method:"DELETE",headers:{"content-type":"application/json",authorization:`Bearer ${r}`}});return s}function yn(t,e){if(!e)return t;const n={};return e.forEach(r=>{n[r]=t[r]}),n}function hs(t,e,n){const r={peers:{}};if(e&&"user"in e?e.user:!0){const i=yn(t.user??{},e==null?void 0:e.keys);r.user={...i,peerId:n}}for(const i of Object.keys(t.peers??{})){const a=(e==null?void 0:e.peers)===void 0,u=Array.isArray(e==null?void 0:e.peers)&&(e==null?void 0:e.peers.includes(i));if(a||u){const l=yn(t.peers[i],e==null?void 0:e.keys);r.peers[i]={...l,peerId:i}}}return r}function ps(t,e){if(t.isLoading!==e.isLoading||t.error!==e.error||(t.user||e.user)&&(!t.user||!e.user||!Nt(t.user,e.user))||!Dt(t.peers,e.peers))return!0;for(const r of Object.keys(t.peers))if(!Nt(t.peers[r],e.peers[r]))return!0;return!1}class gn{constructor(){D(this,"promise");D(this,"_resolve");D(this,"_reject");this.promise=new Promise((e,n)=>{this._resolve=e,this._reject=n})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}}class bn{constructor(e,n,r,s,i=l=>JSON.stringify(l),a=l=>JSON.parse(l),u=100){this._persister=e,this._key=n,this._onMerge=s,this._loadedCbs=[],this._isLoading=!0,this.currentValue=r,this.toJSON=i,this.fromJSON=a,this._saveThrottleMs=u,this._pendingSaveCbs=[],this._version=0,this._load()}async _load(){const e=this.fromJSON(await this._persister.getItem(this._key));this._isLoading=!1,this._onMerge(e,this.currentValue);for(const n of this._loadedCbs)n()}async waitForLoaded(){if(!this._isLoading)return;await new Promise(n=>{this._loadedCbs.push(n)})}isLoading(){return this._isLoading}version(){return this._version}async waitForSync(){if(!this._nextSave)return;await new Promise(n=>{this._pendingSaveCbs.push(n)})}_writeToStorage(){this._persister.setItem(this._key,this.toJSON(this.currentValue));for(const e of this._pendingSaveCbs)e();this._pendingSaveCbs.length=0}async flush(){this._nextSave&&(clearTimeout(this._nextSave),this._writeToStorage())}_enqueuePersist(e){if(this._nextSave){e&&this._pendingSaveCbs.push(e);return}this._nextSave=setTimeout(()=>{this._nextSave=null,this._writeToStorage()},this._saveThrottleMs)}set(e,n){this._version++,this.currentValue=e(this.currentValue),this._isLoading?this._loadedCbs.push(()=>this._enqueuePersist(n)):this._enqueuePersist(n)}}function wn(t,e=[]){t.forEach(n=>{const{data:r}=n,{"datalog-result":s}=r,{"join-rows":i}=s;for(const a of i)for(const u of a)e.push(u);wn(n["child-nodes"],e)})}function mn(t){const e=[];return wn(t,e),e}function ys(t){return Object.values(t.links).reduce((e,n)=>{var r,s;return e[r=n.forward.on]??(e[r]={}),e[n.forward.on][n.forward.label]={isForward:!0,isSingular:n.forward.has==="one",link:n},e[s=n.reverse.on]??(e[s]={}),e[n.reverse.on][n.reverse.label]={isForward:!1,isSingular:n.reverse.has==="one",link:n},e},{})}const Oe={CONNECTING:"connecting",OPENED:"opened",AUTHENTICATED:"authenticated",CLOSED:"closed",ERRORED:"errored"},gs=1e4,_n=1,bs={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"},vt="_instant_oauth_redirect",St="currentUser";function ws(){return typeof window<"u"||typeof chrome<"u"}function ms(t){var n;const e=JSON.parse(t);for(const r in e){const s=e[r];(n=s==null?void 0:s.result)!=null&&n.store&&(s.result.store=Vn(s.result.store))}return e}function _s(t){var n;const e={};for(const r in t){const s=t[r],i={...s};(n=s.result)!=null&&n.store&&(i.result={...s.result,store:$n(s.result.store)}),e[r]=i}return JSON.stringify(e)}class vs{constructor(e,n=mt,r=_t){D(this,"attrs");D(this,"_isOnline",!0);D(this,"_isShutdown",!1);D(this,"status",Oe.CONNECTING);D(this,"querySubs");D(this,"pendingMutations");D(this,"queryCbs",{});D(this,"queryOnceDfds",{});D(this,"authCbs",[]);D(this,"attrsCbs",[]);D(this,"mutationErrorCbs",[]);D(this,"config");D(this,"_persister");D(this,"mutationDeferredStore",new Map);D(this,"_reconnectTimeoutId",null);D(this,"_reconnectTimeoutMs",0);D(this,"_ws");D(this,"_localIdPromises",{});D(this,"_errorMessage",null);D(this,"_oauthCallbackResponse",null);D(this,"_linkIndex",null);D(this,"_broadcastChannel");D(this,"_rooms",{});D(this,"_roomsPendingLeave",{});D(this,"_presence",{});D(this,"_broadcastQueue",[]);D(this,"_broadcastSubs",{});D(this,"_currentUserCached",{isLoading:!0,error:void 0,user:void 0});D(this,"_beforeUnloadCbs",[]);D(this,"_dataForQueryCache",{});D(this,"_onMergeQuerySubs",(e,n)=>{const r=e||{},s={...n};Object.entries(n).forEach(([a,u])=>{var b;const l=(b=r==null?void 0:r[a])==null?void 0:b.result,p=u.result;l&&!p&&(s[a].result=l)}),Object.keys(r).filter(a=>!n[a]).slice(0,10).forEach(a=>{s[a]=r[a]}),this.querySubs.set(a=>s),this.loadedNotifyAll()});D(this,"_onMergePendingMutations",(e,n)=>{const r=new Map([...e.entries(),...n.entries()]);this.pendingMutations.set(i=>r),this.loadedNotifyAll(),this._rewriteMutations(this.attrs,e).forEach((i,a)=>{!n.has(a)&&!i["tx-id"]&&this._sendMutation(a,i)})});D(this,"getPreviousResult",e=>{const n=be(e);return this.dataForQuery(n)});D(this,"notifyOne",e=>{var i;const n=this.queryCbs[e]??[],r=(i=this._dataForQueryCache[e])==null?void 0:i.data,s=this.dataForQuery(e);s&&($e(s,r)||n.forEach(a=>a.cb(s)))});D(this,"notifyOneQueryOnce",e=>{const n=this.queryOnceDfds[e]??[],r=this.dataForQuery(e);n.forEach(s=>{this._completeQueryOnce(s.q,e,s.dfd),s.dfd.resolve(r)})});D(this,"notifyQueryError",(e,n)=>{(this.queryCbs[e]||[]).forEach(s=>s.cb({error:n}))});D(this,"pushTx",e=>{try{const n=kr(this.optimisticAttrs(),e);return this.pushOps(n)}catch(n){return this.pushOps([],n)}});D(this,"pushOps",(e,n)=>{const r=ne(),s={op:"transact","tx-steps":e,error:n};this.pendingMutations.set(a=>(a.set(r,s),a));const i=new gn;return this.mutationDeferredStore.set(r,i),this._sendMutation(r,s),this.notifyAll(),i.promise});D(this,"_wsOnOpen",()=>{G.info("[socket] connected"),this._setStatus(Oe.OPENED),this.getCurrentUser().then(e=>{var n;this._trySend(ne(),{op:"init","app-id":this.config.appId,"refresh-token":(n=e.user)==null?void 0:n.refresh_token,"__admin-token":this.config.__adminToken})})});D(this,"_wsOnMessage",e=>{this._handleReceive(JSON.parse(e.data.toString()))});D(this,"_wsOnError",e=>{G.error("[socket] error: ",e)});D(this,"_wsOnClose",()=>{this._setStatus(Oe.CLOSED);for(const e of Object.values(this._rooms))e.isConnected=!1;if(this._isShutdown){G.info("[socket-close] socket has been shut down and will not reconnect");return}if(this._isManualClose){this._isManualClose=!1,G.info("[socket-close] manual close, will not reconnect");return}G.info("[socket-close] scheduling reconnect",this._reconnectTimeoutMs),setTimeout(()=>{if(this._reconnectTimeoutMs=Math.min(this._reconnectTimeoutMs+1e3,1e4),!this._isOnline){G.info("[socket-close] we are offline, no need to start socket");return}this._startSocket()},this._reconnectTimeoutMs)});this.config={...bs,...e},this.config.schema&&(this._linkIndex=ys(this.config.schema)),ws()&&(typeof BroadcastChannel=="function"&&(this._broadcastChannel=new BroadcastChannel("@instantdb"),this._broadcastChannel.addEventListener("message",async s=>{var i;if(((i=s.data)==null?void 0:i.type)==="auth"){const a=await this.getCurrentUser();this.updateUser(a.user)}})),this._oauthCallbackResponse=this._oauthLoginInit(),this._initStorage(n),this.getCurrentUser(),r.getIsOnline().then(s=>{this._isOnline=s,this._startSocket(),r.listen(i=>{i!==this._isOnline&&(this._isOnline=i,this._isOnline&&this._startSocket())})}),typeof addEventListener<"u"&&(this._beforeUnload=this._beforeUnload.bind(this),addEventListener("beforeunload",this._beforeUnload)))}_initStorage(e){this._persister=new e(`instant_${this.config.appId}_5`),this.querySubs=new bn(this._persister,"querySubs",{},this._onMergeQuerySubs,_s,ms),this.pendingMutations=new bn(this._persister,"pendingMutations",new Map,this._onMergePendingMutations,n=>JSON.stringify([...n.entries()]),n=>new Map(JSON.parse(n))),this._beforeUnloadCbs.push(()=>{this.pendingMutations.flush(),this.querySubs.flush()})}_beforeUnload(){for(const e of this._beforeUnloadCbs)e()}_finishTransaction(e,n,r){const s=this.mutationDeferredStore.get(n);this.mutationDeferredStore.delete(n);const i=e!=="error"&&e!=="timeout";!s&&!i&&console.error("Mutation failed",{status:e,clientId:n,...r}),s&&(i?s.resolve({status:e,clientId:n}):s.reject({status:e,clientId:n,...r}))}_setStatus(e,n){this.status=e,this._errorMessage=n}_cleanPendingMutations(e){this.pendingMutations.set(n=>{const r=new Map(n);return[...n.entries()].forEach(([s,i])=>{i["tx-id"]<=e&&r.delete(s)}),r})}_flushEnqueuedRoomData(e){var s,i;const n=(i=(s=this._presence[e])==null?void 0:s.result)==null?void 0:i.user,r=this._broadcastQueue[e];if(this._broadcastQueue[e]=[],n&&this._trySetPresence(e,n),r)for(const a of r){const{topic:u,roomType:l,data:p}=a;this._tryBroadcast(e,l,u,p)}}_handleReceive(e){var r,s,i,a;const n=!!this.config.schema&&("cardinalityInference"in this.config?!!this.config.cardinalityInference:!0);switch(e.op){case"init-ok":this._setStatus(Oe.AUTHENTICATED),this._reconnectTimeoutMs=0,this._setAttrs(e.attrs),this._flushPendingMessages(),this._sessionId=e["session-id"];for(const T of Object.keys(this._rooms))this._tryJoinRoom(T);break;case"add-query-exists":this.notifyOneQueryOnce(be(e.q));break;case"add-query-ok":const{q:u,result:l,"processed-tx-id":p}=e;this._cleanPendingMutations(p);const b=be(u),E=(s=(r=l==null?void 0:l[0])==null?void 0:r.data)==null?void 0:s["page-info"],P=(a=(i=l==null?void 0:l[0])==null?void 0:i.data)==null?void 0:a.aggregate,L=mn(l),S=dt(this.attrs,L,n,this._linkIndex);this.querySubs.set(T=>(T[b].result={store:S,pageInfo:E,aggregate:P},T)),this.notifyOne(b),this.notifyOneQueryOnce(b);break;case"refresh-ok":const{computations:x,attrs:m,"processed-tx-id":A}=e;this._cleanPendingMutations(A),this._setAttrs(m);const M=x.map(T=>{var Be,xe,Te,De;const $=T["instaql-query"],Q=T["instaql-result"],J=be($),V=mn(Q),de=dt(this.attrs,V,n,this._linkIndex),Ge=(xe=(Be=Q==null?void 0:Q[0])==null?void 0:Be.data)==null?void 0:xe["page-info"],je=(De=(Te=Q==null?void 0:Q[0])==null?void 0:Te.data)==null?void 0:De.aggregate;return{hash:J,store:de,pageInfo:Ge,aggregate:je}});M.forEach(({hash:T,store:$,pageInfo:Q,aggregate:J})=>{this.querySubs.set(V=>(V[T].result={store:$,pageInfo:Q,aggregate:J},V))}),M.forEach(({hash:T})=>{this.notifyOne(T)});break;case"transact-ok":const{"client-event-id":O,"tx-id":j}=e,g=this._rewriteMutations(this.attrs,this.pendingMutations.currentValue).get(O);if(!g)break;const v={...g,"tx-id":j};this.pendingMutations.set(T=>(T.set(O,v),T)),this._finishTransaction("synced",O);const f=g["tx-steps"].filter(([T,...$])=>T==="add-attr").map(([T,$])=>$).concat(Object.values(this.attrs));this._setAttrs(f);break;case"refresh-presence":const h=e["room-id"];this._setPresencePeers(h,e.data),this._notifyPresenceSubs(h);break;case"server-broadcast":const c=e["room-id"],w=e.topic;this._notifyBroadcastSubs(c,w,e);break;case"join-room-ok":const _=e["room-id"],N=this._rooms[_];if(!N){this._roomsPendingLeave[h]&&(this._tryLeaveRoom(_),delete this._roomsPendingLeave[h]);break}N.isConnected=!0,this._notifyPresenceSubs(_),this._flushEnqueuedRoomData(_);break;case"join-room-error":const B=e["room-id"],q=this._rooms[B];q&&(q.error=e.error),this._notifyPresenceSubs(B);break;case"error":this._handleReceiveError(e);break}}_handleMutationError(e,n,r){const s=this.pendingMutations.currentValue.get(n);s&&(e!=="timeout"||!s["tx-id"])&&(this.pendingMutations.set(i=>(i.delete(n),i)),this.notifyAll(),this.notifyAttrsSubs(),this.notifyMutationErrorSubs(r),this._finishTransaction(e,n,r))}_handleReceiveError(e){var l,p,b;const n=e["client-event-id"],r=this.pendingMutations.currentValue.get(n),s={message:e.message||"Uh-oh, something went wrong. Ping Joe & Stopa."};if(r){const E={message:e.message,hint:e.hint};this._handleMutationError("error",n,E);return}const i=e.q||((l=e["original-event"])==null?void 0:l.q);if(i){const E=be(i);this.querySubs.set(P=>(delete P[E],P)),this.notifyQueryError(be(i),s),this.notifyQueryOnceError(E,n,s);return}if(((p=e["original-event"])==null?void 0:p.op)==="init"){if(e.type==="record-not-found"&&((b=e.hint)==null?void 0:b["record-type"])==="app-user"){this.changeCurrentUser(null);return}this._setStatus(Oe.ERRORED,s),this.notifyAll();return}const u={...e};delete u.message,delete u.hint,console.error(e.message,u),e.hint&&console.error(`This error comes with some debugging information. Here it is: 
`,e.hint)}notifyQueryOnceError(e,n,r){var i;const s=(i=this.queryOnceDfds[e])==null?void 0:i.find(a=>a.eventId===n);s&&s.dfd.reject(r)}_setAttrs(e){this.attrs=e.reduce((n,r)=>(n[r.id]=r,n),{}),this.notifyAttrsSubs()}_startQuerySub(e,n){const r=ne();return this.querySubs.set(s=>(s[n]=s[n]||{q:e,result:null,eventId:r},s)),this._trySendAuthed(r,{op:"add-query",q:e}),r}subscribeQuery(e,n){const r=be(e),s=this.getPreviousResult(e);return s&&n(s),this.queryCbs[r]=this.queryCbs[r]??[],this.queryCbs[r].push({q:e,cb:n}),this._startQuerySub(e,r),()=>{this._unsubQuery(e,r,n)}}async queryOnce(e){if(!this._isOnline)throw new Error("Offline: Cannot execute query because the device is offline.");const n=be(e),r=new gn,s=this._startQuerySub(e,n);return this.queryOnceDfds[n]=this.queryOnceDfds[n]??[],this.queryOnceDfds[n].push({q:e,dfd:r,eventId:s}),setTimeout(()=>r.reject(new Error("Query timed out")),gs),r.promise}_completeQueryOnce(e,n,r){this.queryOnceDfds[n]&&(this.queryOnceDfds[n]=this.queryOnceDfds[n].filter(s=>s.dfd!==r),this._cleanupQuery(e,n))}_unsubQuery(e,n,r){this.queryCbs[n]&&(this.queryCbs[n]=this.queryCbs[n].filter(s=>s.cb!==r),this._cleanupQuery(e,n))}_cleanupQuery(e,n){var s,i;(s=this.queryCbs[n])!=null&&s.length||(i=this.queryOnceDfds[n])!=null&&i.length||(delete this.queryCbs[n],delete this.queryOnceDfds[n],this._trySendAuthed(ne(),{op:"remove-query",q:e}))}_rewriteMutations(e,n){if(!e)return n;const r=l=>{const[p,b,E]=l["forward-identity"];return re(e,b,E)},s=l=>{const[p,b,E]=l["forward-identity"];return Ce(e,b,E)},i={attrIdMap:{},refSwapAttrIds:new Set},a=l=>{const p=[];for(const b of l){const[E]=b;if(E==="add-attr"){const[L,S]=b,x=r(S);if(x){i.attrIdMap[S.id]=x.id;continue}if(S["value-type"]==="ref"){const m=s(S);if(m){i.attrIdMap[S.id]=m.id,i.refSwapAttrIds.add(S.id);continue}}}const P=_r(i,b);p.push(P)}return p},u=new Map;for(const[l,p]of n.entries())u.set(l,{...p,"tx-steps":a(p["tx-steps"])});return u}optimisticAttrs(){var a;const e=[...this.pendingMutations.currentValue.values()].flatMap(u=>u["tx-steps"]),n=new Set(e.filter(([u,l])=>u==="delete-attr").map(([u,l])=>l)),r=[];for(const[u,l]of e)if(u==="add-attr")r.push(l);else if(u==="update-attr"&&l.id&&((a=this.attrs)!=null&&a[l.id])){const p={...this.attrs[l.id],...l};r.push(p)}const s=[...Object.values(this.attrs||{}),...r].filter(u=>!n.has(u.id));return Object.fromEntries(s.map(u=>[u.id,u]))}dataForQuery(e){const n=this._errorMessage;if(n)return{error:n};if(!this.querySubs||!this.pendingMutations)return;const r=this.querySubs.version(),s=this.querySubs.currentValue,i=this.pendingMutations.version(),a=this.pendingMutations.currentValue,{q:u,result:l}=s[e]||{};if(!l)return;const p=this._dataForQueryCache[e];if(p&&r===p.querySubVersion&&i===p.pendingMutationsVersion)return p.data;const{store:b,pageInfo:E,aggregate:P}=l,S=[...this._rewriteMutations(b.attrs,a).values()].flatMap(A=>A["tx-steps"]),x=nr(b,S),m=rs({store:x,pageInfo:E,aggregate:P},u);return this._dataForQueryCache[e]={querySubVersion:r,pendingMutationsVersion:i,data:m},m}notifyAll(){Object.keys(this.queryCbs).forEach(e=>{this.notifyOne(e)})}loadedNotifyAll(){this.pendingMutations.isLoading()||this.querySubs.isLoading()||this.notifyAll()}shutdown(){this._isShutdown=!0,this._ws.close()}_sendMutation(e,n){if(n.error){this._handleMutationError("error",e,{error:n.error,message:n.error.message});return}if(this.status!==Oe.AUTHENTICATED){this._finishTransaction("enqueued",e);return}const r=Math.max(5e3,this.pendingMutations.currentValue.size*5e3);this._isOnline?(this._trySend(e,n),setTimeout(()=>{this._finishTransaction("pending",e)},3e3),setTimeout(()=>{this._isOnline&&this._handleMutationError("timeout",e,{message:"transaction timed out"})},r)):this._finishTransaction("enqueued",e)}_flushPendingMessages(){Object.keys(this.queryCbs).map(s=>this.querySubs.currentValue[s]).filter(s=>s).forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),Object.values(this.queryOnceDfds).flat().forEach(({eventId:s,q:i})=>{this._trySendAuthed(s,{op:"add-query",q:i})}),this._rewriteMutations(this.attrs,this.pendingMutations.currentValue).forEach((s,i)=>{s["tx-id"]||this._sendMutation(i,s)})}_trySendAuthed(e,n){this.status===Oe.AUTHENTICATED&&this._trySend(e,n)}_trySend(e,n){this._ws.readyState===_n&&this._ws.send(JSON.stringify({"client-event-id":e,...n}))}_ensurePreviousSocketClosed(){this._ws&&this._ws.readyState===_n&&(this._isManualClose=!0,this._ws.close())}_startSocket(){this._ensurePreviousSocketClosed(),this._ws=new WebSocket(`${this.config.websocketURI}?app_id=${this.config.appId}`),this._ws.onopen=this._wsOnOpen,this._ws.onmessage=this._wsOnMessage,this._ws.onclose=this._wsOnClose}async getLocalId(e){const n=`localToken_${e}`,r=await this._persister.getItem(n);if(r)return r;if(this._localIdPromises[n])return this._localIdPromises[n];const s=ne();return this._localIdPromises[n]=this._persister.setItem(n,s).then(()=>s),this._localIdPromises[n]}_replaceUrlAfterOAuth(){if(typeof URL>"u")return;const e=new URL(window.location.href);if(e.searchParams.get(vt)){const n=e.toString();e.searchParams.delete(vt),e.searchParams.delete("code"),e.searchParams.delete("error");const r=e.pathname+(e.searchParams.size?"?"+e.searchParams:"")+e.hash;if(history.replaceState(history.state,"",r),typeof navigation=="object"&&typeof navigation.addEventListener=="function"&&typeof navigation.removeEventListener=="function"){let s=!1;const i=a=>{var u;s||(s=!0,navigation.removeEventListener("navigate",i),!a.userInitiated&&a.navigationType==="replace"&&((u=a.destination)==null?void 0:u.url)===n&&history.replaceState(history.state,"",r))};navigation.addEventListener("navigate",i)}}}async _oauthLoginInit(){var s,i,a,u;if(typeof window>"u"||typeof window.location>"u"||typeof URLSearchParams>"u")return null;const e=new URLSearchParams(window.location.search);if(!e.get(vt))return null;const n=e.get("error");if(n)return this._replaceUrlAfterOAuth(),{error:{message:n}};const r=e.get("code");if(!r)return null;this._replaceUrlAfterOAuth();try{const{user:l}=await pn({apiURI:this.config.apiURI,appId:this.config.appId,code:r});return this.setCurrentUser(l),null}catch(l){return((s=l==null?void 0:l.body)==null?void 0:s.type)==="record-not-found"&&((a=(i=l==null?void 0:l.body)==null?void 0:i.hint)==null?void 0:a["record-type"])==="app-oauth-code"&&await this._hasCurrentUser()?null:{error:{message:((u=l==null?void 0:l.body)==null?void 0:u.message)||"Error logging in."}}}}async _waitForOAuthCallbackResponse(){return await this._oauthCallbackResponse}__subscribeMutationErrors(e){return this.mutationErrorCbs.push(e),()=>{this.mutationErrorCbs=this.mutationErrorCbs.filter(n=>n!==e)}}subscribeAuth(e){this.authCbs.push(e);const n=this._currentUserCached;n.isLoading||e(this._currentUserCached);let r=!1;return this.getCurrentUser().then(s=>{r||$e(s,n)||e(s)}),()=>{r=!0,this.authCbs=this.authCbs.filter(s=>s!==e)}}subscribeAttrs(e){return this.attrsCbs.push(e),this.attrs&&e(this.attrs),()=>{this.attrsCbs=this.attrsCbs.filter(n=>n!==e)}}notifyAuthSubs(e){this.authCbs.forEach(n=>n(e))}notifyMutationErrorSubs(e){this.mutationErrorCbs.forEach(n=>n(e))}notifyAttrsSubs(){if(!this.attrs)return;const e=this.optimisticAttrs();this.attrsCbs.forEach(n=>n(e))}async setCurrentUser(e){await this._persister.setItem(St,JSON.stringify(e))}getCurrentUserCached(){return this._currentUserCached}async getCurrentUser(){const e=await this._waitForOAuthCallbackResponse();if(e!=null&&e.error){const s={error:e.error,user:void 0};return this._currentUserCached={isLoading:!1,...s},s}const n=await this._persister.getItem(St),r={user:JSON.parse(n),error:void 0};return this._currentUserCached={isLoading:!1,...r},r}async _hasCurrentUser(){const e=await this._persister.getItem(St);return JSON.parse(e)!=null}async changeCurrentUser(e){var r;const{user:n}=await this.getCurrentUser();if(!$e(n,e)){await this.setCurrentUser(e),this.updateUser(e);try{(r=this._broadcastChannel)==null||r.postMessage({type:"auth"})}catch(s){console.error("Error posting message to broadcast channel",s)}}}updateUser(e){const n={error:void 0,user:e};this._currentUserCached={isLoading:!1,...n},this.querySubs.set(r=>(Object.keys(r).forEach(s=>{delete r[s].result}),r)),this._reconnectTimeoutMs=0,this._ws.close(),this._oauthCallbackResponse=null,this.notifyAuthSubs(n)}sendMagicCode({email:e}){return ss({apiURI:this.config.apiURI,appId:this.config.appId,email:e})}async signInWithMagicCode({email:e,code:n}){const r=await is({apiURI:this.config.apiURI,appId:this.config.appId,email:e,code:n});return this.changeCurrentUser(r.user),r}async signInWithCustomToken(e){const n=await os({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:e});this.changeCurrentUser(n.user)}async signOut(){var r;const e=await this.getCurrentUser(),n=(r=e==null?void 0:e.user)==null?void 0:r.refresh_token;if(n)try{await us({apiURI:this.config.apiURI,appId:this.config.appId,refreshToken:n})}catch{}this.changeCurrentUser(null)}createAuthorizationURL({clientName:e,redirectURL:n}){const{apiURI:r,appId:s}=this.config;return`${r}/runtime/oauth/start?app_id=${s}&client_name=${e}&redirect_uri=${n}`}async exchangeCodeForToken({code:e,codeVerifier:n}){const r=await pn({apiURI:this.config.apiURI,appId:this.config.appId,code:e,codeVerifier:n});return this.changeCurrentUser(r.user),r}issuerURI(){const{apiURI:e,appId:n}=this.config;return`${e}/runtime/${n}`}async signInWithIdToken({idToken:e,clientName:n,nonce:r}){var u;const s=await this.getCurrentUser(),i=(u=s==null?void 0:s.user)==null?void 0:u.refresh_token,a=await as({apiURI:this.config.apiURI,appId:this.config.appId,idToken:e,clientName:n,nonce:r,refreshToken:i});return this.changeCurrentUser(a.user),a}joinRoom(e){return this._rooms[e]||(this._rooms[e]={isConnected:!1,error:void 0}),this._tryJoinRoom(e),()=>{this._cleanupRoom(e)}}_cleanupRoom(e){var n,r,s;if(!((r=(n=this._presence[e])==null?void 0:n.handlers)!=null&&r.length)&&!Object.keys(this._broadcastSubs[e]??{}).length){const i=(s=this._rooms[e])==null?void 0:s.isConnected;delete this._rooms[e],delete this._presence[e],delete this._broadcastSubs[e],i?this._tryLeaveRoom(e):this._roomsPendingLeave[e]=!0}}getPresence(e,n,r={}){const s=this._rooms[n],i=this._presence[n];return!s||!i||!i.result?null:{...hs(i.result,r,this._sessionId),isLoading:!s.isConnected,error:s.error}}publishPresence(e,n,r){const s=this._rooms[n],i=this._presence[n];if(!s||!i)return;i.result=i.result||{};const a={...i.result.user,...r};i.result.user=a,s.isConnected&&(this._trySetPresence(n,a),this._notifyPresenceSubs(n))}_trySetPresence(e,n){this._trySendAuthed(ne(),{op:"set-presence","room-id":e,data:n})}_tryJoinRoom(e){this._trySendAuthed(ne(),{op:"join-room","room-id":e}),delete this._roomsPendingLeave[e]}_tryLeaveRoom(e){this._trySendAuthed(ne(),{op:"leave-room","room-id":e})}subscribePresence(e,n,r,s){const i=this.joinRoom(n),a={...r,roomId:n,cb:s,prev:null};return this._presence[n]=this._presence[n]||{},this._presence[n].handlers=this._presence[n].handlers||[],this._presence[n].handlers.push(a),this._notifyPresenceSub(n,a),()=>{var u,l;this._presence[n].handlers=((l=(u=this._presence[n])==null?void 0:u.handlers)==null?void 0:l.filter(p=>p!==a))??[],i()}}_notifyPresenceSubs(e){var n,r;(r=(n=this._presence[e])==null?void 0:n.handlers)==null||r.forEach(s=>{this._notifyPresenceSub(e,s)})}_notifyPresenceSub(e,n){const r=this.getPresence("",e,n);r&&(n.prev&&!ps(r,n.prev)||(n.prev=r,n.cb(r)))}_setPresencePeers(e,n){const r={...n};delete r[this._sessionId];const s=Object.fromEntries(Object.entries(r).map(([i,a])=>[i,a.data]));this._presence[e]=this._presence[e]||{},this._presence[e].result=this._presence[e].result||{},this._presence[e].result.peers=s}publishTopic({roomType:e,roomId:n,topic:r,data:s}){const i=this._rooms[n];if(i){if(!i.isConnected){this._broadcastQueue[n]=this._broadcastQueue[n]??[],this._broadcastQueue[n].push({topic:r,roomType:e,data:s});return}this._tryBroadcast(n,e,r,s)}}_tryBroadcast(e,n,r,s){this._trySendAuthed(ne(),{op:"client-broadcast","room-id":e,roomType:n,topic:r,data:s})}subscribeTopic(e,n,r){const s=this.joinRoom(e);return this._broadcastSubs[e]=this._broadcastSubs[e]||{},this._broadcastSubs[e][n]=this._broadcastSubs[e][n]||[],this._broadcastSubs[e][n].push(r),this._presence[e]=this._presence[e]||{},()=>{this._broadcastSubs[e][n]=this._broadcastSubs[e][n].filter(i=>i!==r),this._broadcastSubs[e][n].length||delete this._broadcastSubs[e][n],s()}}_notifyBroadcastSubs(e,n,r){var s,i,a;(a=(i=(s=this._broadcastSubs)==null?void 0:s[e])==null?void 0:i[n])==null||a.forEach(u=>{var b,E,P,L,S,x;const l=(b=r.data)==null?void 0:b.data,p=r.data["peer-id"]===this._sessionId?(P=(E=this._presence[e])==null?void 0:E.result)==null?void 0:P.user:(x=(S=(L=this._presence[e])==null?void 0:L.result)==null?void 0:S.peers)==null?void 0:x[r.data["peer-id"]];return u(l,p)})}async upload(e,n){var l;const r=await this.getCurrentUser(),s=(l=r==null?void 0:r.user)==null?void 0:l.refresh_token,i=e||n.name,a=await cs({apiURI:this.config.apiURI,appId:this.config.appId,fileName:i,refreshToken:s});return await fs(a,n)}async getDownloadUrl(e){var i;const n=await this.getCurrentUser(),r=(i=n==null?void 0:n.user)==null?void 0:i.refresh_token;return await ls({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}async deleteFile(e){var i;const n=await this.getCurrentUser(),r=(i=n==null?void 0:n.user)==null?void 0:i.refresh_token;return await ds({apiURI:this.config.apiURI,appId:this.config.appId,path:e,refreshToken:r})}}class ve{constructor(e,n,r={indexed:!1,unique:!1}){this.valueType=e,this.required=n,this.config=r}optional(){return new ve(this.valueType,!1)}unique(){return new ve(this.valueType,this.required,{...this.config,unique:!0})}indexed(){return new ve(this.valueType,this.required,{...this.config,indexed:!0})}}class Et{constructor(e,n){this.entities=e,this.links=n}withRoomSchema(){return new Et(this.entities,this.links)}}class Ke{constructor(e,n){this.attrs=e,this.links=n}asType(){return new Ke(this.attrs,this.links)}}function Ss(t,e){return new Et(js(t,e),e)}function Es(t){return new Ke(t,{})}function As(){return new ve("string",!0)}function Os(){return new ve("number",!0)}function Is(){return new ve("boolean",!0)}function Ms(){return new ve("json",!0)}function Cs(){return new ve("json",!0)}function js(t,e){var s,i,a,u;const n={fwd:{},rev:{}};for(const l of Object.values(e))(s=n.fwd)[i=l.forward.on]||(s[i]={}),(a=n.rev)[u=l.reverse.on]||(a[u]={}),n.fwd[l.forward.on][l.forward.label]={entityName:l.reverse.on,cardinality:l.forward.has},n.rev[l.reverse.on][l.reverse.label]={entityName:l.forward.on,cardinality:l.reverse.has};return Object.fromEntries(Object.entries(t).map(([l,p])=>[l,new Ke(p.attrs,{...n.fwd[l],...n.rev[l]})]))}const xs={graph:Ss,entity:Es,string:As,number:Os,boolean:Is,json:Ms,any:Cs};let He;function Ts(t){He==null||He.dispose();const e=ks(),n=Ps(a),r=Rs(Us(t));function s(p){var b;p.source===r.element.contentWindow&&((b=p.data)==null?void 0:b.type)==="close"&&e.isVisible()&&a()}function i(p){const b=p.shiftKey&&p.ctrlKey&&p.key==="0",E=p.key==="Escape"||p.key==="Esc";(b||E)&&a()}function a(){e.isVisible()?e.element.style.display="none":(e.element.style.display="block",e.element.contains(r.element)||e.element.appendChild(r.element))}function u(){e.element.remove(),n.element.remove(),removeEventListener("keydown",i),removeEventListener("message",s)}function l(){document.body.appendChild(e.element),document.body.appendChild(n.element),addEventListener("keydown",i),addEventListener("message",s),He={dispose:u}}return l()}function Us(t){return`${window.DEV_DEVTOOL?"http://localhost:3000":"https://instantdb.com"}/_devtool?appId=${t}`}function Rs(t){const e=document.createElement("iframe");return e.src=t,Object.assign(e.style,{width:"100%",height:"100%",borderRadius:"4px",backgroundColor:"white",border:"none"}),{element:e}}function Ps(t){const e=`
    <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
      <rect width="512" height="512" fill="black"/>
      <rect x="97.0973" y="91.3297" width="140" height="330" fill="white"/>
    </svg>
  `,n=document.createElement("button");return n.innerHTML=e,Object.assign(n.style,{position:"fixed",bottom:"24px",left:"24px",height:"32px",width:"32px",display:"flex",alignItems:"center",justifyContent:"center",padding:"0",margin:"0",border:"none",cursor:"pointer"}),n.addEventListener("click",t),{element:n}}function ks(){const t=document.createElement("div");Object.assign(t.style,{position:"fixed",bottom:"24px",right:"24px",left:"60px",top:"72px",display:"block",borderRadius:"4px",border:"1px #ccc solid",boxShadow:"0px 0px 8px #00000044",backgroundColor:"#eee",zIndex:"999990"}),t.style.display="none";function e(){return t.style.display!=="none"}return{element:t,isVisible:e}}const Ls=!0,Bs={apiURI:"https://api.instantdb.com",websocketURI:"wss://api.instantdb.com/runtime/session"};function Ds(){return globalThis.__instantDbStore=globalThis.__instantDbStore??{},globalThis.__instantDbStore}const At=Ds();function Ns(t,e,n){return Ot(t,e,n)}function qs(t,e,n){return Ot(t,e,n)}function Ot(t,e,n){const r=At[t.appId];if(r)return r;const s=new vs({...Bs,...t},e||mt,n||_t),i=new vn(s);return At[t.appId]=i,typeof window<"u"&&typeof window.location<"u"&&("devtool"in t?t.devtool:Ls)&&window.location.hostname==="localhost"&&!globalThis._nodevtool&&Ts(t.appId),i}class vn{constructor(e){this.tx=bt(),this._reactor=e,this.auth=new Sn(this._reactor),this.storage=new En(this._reactor)}transact(e){return this._reactor.pushTx(e)}getLocalId(e){return this._reactor.getLocalId(e)}subscribeQuery(e,n){return this._reactor.subscribeQuery(e,n)}subscribeAuth(e){return this._reactor.subscribeAuth(e)}joinRoom(e="_defaultRoomType",n="_defaultRoomId"){return{leaveRoom:this._reactor.joinRoom(n),subscribeTopic:(s,i)=>this._reactor.subscribeTopic(n,s,i),subscribePresence:(s,i)=>this._reactor.subscribePresence(e,n,s,i),publishTopic:(s,i)=>this._reactor.publishTopic({roomType:e,roomId:n,topic:s,data:i}),publishPresence:s=>this._reactor.publishPresence(e,n,s),getPresence:s=>this._reactor.getPresence(e,n,s)}}shutdown(){delete At[this._reactor.config.appId],this._reactor.shutdown()}queryOnce(e){return this._reactor.queryOnce(e)}}class Sn{constructor(e){this.db=e,this.sendMagicCode=n=>this.db.sendMagicCode(n),this.signInWithMagicCode=n=>this.db.signInWithMagicCode(n),this.signInWithToken=n=>this.db.signInWithCustomToken(n),this.createAuthorizationURL=n=>this.db.createAuthorizationURL(n),this.signInWithIdToken=n=>this.db.signInWithIdToken(n),this.exchangeOAuthCode=n=>this.db.exchangeCodeForToken(n),this.issuerURI=()=>this.db.issuerURI(),this.signOut=()=>this.db.signOut()}}class En{constructor(e){this.db=e,this.upload=(n,r)=>this.db.upload(n,r),this.put=this.upload,this.getDownloadUrl=n=>this.db.getDownloadUrl(n),this.delete=n=>this.db.deleteFile(n)}}function Fs(t){return JSON.parse(JSON.stringify(t))}W.Auth=Sn,W.IndexedDBStorage=mt,W.InstantClient=vn,W.Storage=En,W.WindowNetworkListener=_t,W._init_internal=Ot,W.coerceQuery=Fs,W.getOps=Zt,W.i=xs,W.id=ne,W.init=qs,W.init_experimental=Ns,W.lookup=br,W.tx=mr,W.txInit=bt,W.weakHash=be,Object.defineProperty(W,Symbol.toStringTag,{value:"Module"})});
